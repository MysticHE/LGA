<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Generation Tool</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Typography */
            --font-family: 'Inter', 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;

            /* Colors */
            --color-white: #ffffff;
            --color-gray-50: #f8fafc;
            --color-gray-100: #f1f5f9;
            --color-gray-200: #e2e8f0;
            --color-gray-300: #cbd5e1;
            --color-gray-400: #94a3b8;
            --color-gray-500: #64748b;
            --color-gray-600: #475569;
            --color-gray-700: #334155;
            --color-gray-800: #1e293b;
            --color-gray-900: #0f172a;

            --color-primary-500: #ff6d5a;
            --color-primary-600: #ea580c;
            --color-primary-700: #c2410c;

            --color-success: #10b981;
            --color-error: #ef4444;
            --color-warning: #f59e0b;
            
            --color-blue-50: #eff6ff;
            --color-blue-200: #bfdbfe;
            --color-blue-400: #60a5fa;
            --color-blue-500: #3b82f6;
            --color-blue-600: #2563eb;
            --color-blue-700: #1d4ed8;
            
            --color-green-50: #ecfdf5;
            --color-green-200: #bbf7d0;
            --color-green-500: #10b981;
            --color-green-600: #059669;
            --color-green-700: #047857;
            
            --color-purple-50: #faf5ff;
            --color-purple-300: #c4b5fd;
            --color-purple-500: #8b5cf6;
            --color-purple-600: #7c3aed;
            --color-purple-700: #6d28d9;
            
            --color-indigo-50: #eef2ff;
            --color-indigo-300: #a5b4fc;
            --color-indigo-500: #6366f1;
            --color-indigo-600: #4f46e5;
            --color-indigo-700: #4338ca;
            
            --color-amber-50: #fffbeb;
            --color-amber-200: #fde68a;
            --color-amber-600: #d97706;
            --color-amber-700: #b45309;
            --color-amber-800: #92400e;

            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-6: 24px;
            --space-8: 32px;

            /* Border radius */
            --border-radius-md: 6px;
            --border-radius-lg: 8px;
            --border-radius-xl: 12px;
            --border-radius-full: 50px;

            /* Shadows */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--color-gray-50);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            /* Grid layout will be set by media queries */
        }

        .filters-panel {
            background: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--space-6);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .results-panel {
            background: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--space-6);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .form-card {
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            margin-bottom: 0;
            position: relative;
            overflow: visible;
        }

        .filters-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-600) 100%);
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
        }

        .results-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
        }

        .form-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .form-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
        }

        .form-description {
            font-size: var(--font-size-md);
            color: var(--color-gray-600);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-content {
            flex: 1;
            overflow-y: auto;
            padding-right: var(--space-2);
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .form-actions {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-gray-100);
            flex-shrink: 0;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-2);
        }

        .form-label .emoji {
            font-size: var(--font-size-base);
        }

        .form-label.required::after {
            content: '*';
            color: var(--color-error);
            margin-left: 4px;
        }

        .select-container {
            position: relative;
        }

        .form-select {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius-md);
            background: var(--color-white);
            color: var(--color-gray-700);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            outline: none;
            transition: border-color 0.15s ease;
        }

        .form-select:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(255, 109, 90, 0.1);
        }

        /* Legacy multi-select styles (kept for compatibility) */
        .multi-select {
            min-height: 120px;
            background-image: none;
        }

        /* Custom Multi-Select with Checkboxes */
        .filter-card {
            background: linear-gradient(135deg, var(--color-gray-50) 0%, var(--color-white) 100%);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .filter-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--color-primary-300);
        }

        .custom-multiselect {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .custom-multiselect:focus-within {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(255, 109, 90, 0.1);
        }

        .multiselect-option {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .option-chip {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-2) var(--space-3);
            background: var(--color-white);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            transition: all 0.2s ease;
            cursor: pointer;
            text-align: center;
            min-height: 32px;
            width: 100%;
        }

        .option-chip:hover {
            background: var(--color-gray-50);
            border-color: var(--color-primary-400);
            transform: translateY(-1px);
        }

        .option-chip.selected {
            background: var(--color-primary-500);
            color: var(--color-white);
            border-color: var(--color-primary-500);
            box-shadow: 0 2px 8px rgba(255, 109, 90, 0.3);
        }

        .multiselect-checkbox {
            display: none;
        }

        .multiselect-label {
            font-size: var(--font-size-xs);
            cursor: pointer;
            display: block;
            width: 100%;
        }

        /* Selected options indicator */
        .selection-preview {
            background: var(--color-primary-50);
            border-radius: var(--border-radius-md);
            padding: var(--space-2);
            font-size: var(--font-size-xs);
            color: var(--color-primary-700);
            text-align: center;
            font-weight: var(--font-weight-medium);
            border: 1px solid var(--color-primary-200);
        }

        .selection-tag {
            display: inline-flex;
            align-items: center;
            background: var(--color-primary-500);
            color: var(--color-white);
            padding: 4px var(--space-3);
            border-radius: var(--border-radius-full);
            font-size: var(--font-size-xs);
            margin: 2px 4px 2px 0;
            gap: var(--space-1);
        }

        .selection-tag .remove {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--transition-colors);
        }

        .selection-tag .remove:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .selection-count {
            font-weight: var(--font-weight-medium);
            color: var(--color-primary-600);
        }

        .submit-btn {
            height: 48px;
            background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-600) 100%);
            color: var(--color-white);
            border: none;
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            font-family: var(--font-family);
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 var(--space-4);
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-700) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px 0 rgba(255, 109, 90, 0.25);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .output-section {
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            margin-top: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .output-section.hidden {
            display: none !important;
        }

        .output-header {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
        }

        .apollo-url {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            word-break: break-all;
            font-family: monospace;
            font-size: var(--font-size-sm);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-6);
            align-items: stretch;
        }

        .btn {
            padding: var(--space-3) var(--space-6);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius-md);
            background: var(--color-white);
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            height: 48px;
            min-height: 48px;
        }

        .btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-400);
        }

        .btn-primary {
            background: var(--color-primary-500);
            color: var(--color-white);
            border-color: var(--color-primary-500);
        }

        .btn-primary:hover {
            background: var(--color-primary-600);
            border-color: var(--color-primary-600);
        }

        .btn-success {
            background: var(--color-success);
            color: var(--color-white);
            border-color: var(--color-success);
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            border-color: #059669;
        }

        .btn-success:disabled {
            background: var(--color-gray-400);
            border-color: var(--color-gray-400);
            color: var(--color-gray-600);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .status-message {
            padding: var(--space-3);
            border-radius: var(--border-radius-md);
            margin: var(--space-4) 0;
            font-size: var(--font-size-sm);
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status-info {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .hidden {
            display: none;
        }

        .processing-options {
            background: var(--color-gray-50);
            border-radius: var(--border-radius-lg);
            padding: var(--space-3);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .processing-row {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            background: var(--color-white);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--color-gray-200);
            font-size: var(--font-size-xs);
        }

        .number-input-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            background: var(--color-white);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--color-gray-200);
            font-size: var(--font-size-xs);
        }

        .number-input-group input {
            width: 60px;
            padding: 2px var(--space-1);
            border: 1px solid var(--color-gray-300);
            border-radius: 4px;
            font-size: var(--font-size-xs);
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
                max-height: 0;
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
                max-height: 300px;
            }
        }

        /* Table styles */
        #leadsTable tbody tr:hover {
            background: var(--color-gray-50);
        }

        #leadsTable td {
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-gray-100);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .panel-header {
            text-align: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-gray-100);
            flex-shrink: 0;
        }

        .panel-header.compact {
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-2);
        }

        .panel-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .panel-description {
            font-size: var(--font-size-xs);
            color: var(--color-gray-600);
        }

        .results-empty-state {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-gray-500);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .results-empty-state.hidden {
            display: none !important;
        }

        .results-empty-state .icon {
            font-size: 3rem;
            margin-bottom: var(--space-3);
            opacity: 0.5;
        }

        .progress-section {
            background: linear-gradient(135deg, var(--color-blue-50) 0%, var(--color-white) 100%);
            border: 1px solid var(--color-blue-200);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        /* Enhanced Progress Styles */
        .progress-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-blue-200);
        }

        .progress-icon {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-blue-300);
            border-top: 3px solid var(--color-blue-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .progress-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-blue-700);
            margin: 0;
        }

        .progress-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-blue-600);
            margin: 0;
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius-md);
            transition: all 0.3s ease;
            animation: slideDown 0.5s ease;
        }

        .progress-step.active {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--color-blue-500);
            animation: pulse 2s infinite;
        }

        .step-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-green-500);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-icon.active {
            background: var(--color-blue-500);
            animation: pulse 1.5s infinite;
        }

        .step-text {
            font-size: var(--font-size-sm);
            color: var(--color-gray-700);
            flex: 1;
        }

        /* Enhanced Logs Section */
        .logs-section {
            background: linear-gradient(135deg, var(--color-gray-900) 0%, var(--color-gray-800) 100%);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin-top: var(--space-4);
        }

        .logs-header {
            background: linear-gradient(135deg, var(--color-gray-800) 0%, var(--color-gray-700) 100%);
            padding: var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-gray-600);
        }

        .logs-title {
            color: var(--color-white);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin: 0;
            width: 100%;
        }

        .logs-loader {
            flex-shrink: 0;
        }

        .logs-loader.hidden {
            display: none !important;
        }

        .logs-controls {
            display: flex;
            gap: var(--space-2);
        }

        .logs-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--color-white);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 0.2s ease;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logs-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .logs-container {
            background: var(--color-gray-900);
            max-height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: var(--font-size-sm);
            line-height: 1.6;
            padding: var(--space-4);
            transition: all 0.3s ease;
        }

        .logs-container::-webkit-scrollbar {
            width: 8px;
        }

        .logs-container::-webkit-scrollbar-track {
            background: var(--color-gray-800);
        }

        .logs-container::-webkit-scrollbar-thumb {
            background: var(--color-gray-600);
            border-radius: 4px;
        }

        .logs-container::-webkit-scrollbar-thumb:hover {
            background: var(--color-gray-500);
        }

        .log-entry {
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
            margin-bottom: var(--space-1);
            padding: var(--space-1) 0;
            border-left: 3px solid transparent;
            padding-left: var(--space-2);
            transition: all 0.2s ease;
            animation: slideDown 0.3s ease;
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: var(--color-blue-500);
        }

        .log-timestamp {
            color: var(--color-gray-400);
            font-size: var(--font-size-xs);
            min-width: 65px;
            flex-shrink: 0;
        }

        .log-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .log-icon.info { background: var(--color-blue-500); }
        .log-icon.progress { background: var(--color-green-500); }
        .log-icon.error { background: var(--color-error); }
        .log-icon.warning { background: var(--color-warning); }
        .log-icon.processing { background: var(--color-blue-400); }

        .log-message {
            color: var(--color-gray-100);
            flex: 1;
            word-wrap: break-word;
        }

        .log-message.info { color: var(--color-blue-200); }
        .log-message.progress { color: var(--color-green-200); }
        .log-message.error { color: #fca5a5; }
        .log-message.warning { color: #fde68a; }
        .log-message.processing { color: var(--color-blue-200); }

        /* Stats Cards */
        .stats-card {
            transition: all 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }

        /* Status Message Improvements */
        .status-enhanced {
            position: relative;
            overflow: hidden;
        }

        .status-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Force side-by-side layout - ALWAYS APPLIED */
        body {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .container {
            display: flex !important;
            flex-direction: row !important;
            gap: 24px !important;
            min-height: 100vh !important;
            padding: 24px !important;
            margin: 0 !important;
            width: 100vw !important;
            max-width: 100vw !important;
            box-sizing: border-box !important;
        }
        
        .filters-panel {
            flex: 0 0 calc(50% - 12px) !important;
            height: calc(100vh - 48px) !important;
            max-height: calc(100vh - 48px) !important;
            overflow-y: auto !important;
        }
        
        .results-panel {
            flex: 0 0 calc(50% - 12px) !important;
            height: calc(100vh - 48px) !important;
            max-height: calc(100vh - 48px) !important;
            overflow-y: auto !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                display: flex;
                flex-direction: column;
                gap: var(--space-4);
                padding: var(--space-3);
                min-height: auto;
            }
            
            .filters-panel, .results-panel {
                height: auto;
                min-height: 400px;
                padding: var(--space-4);
            }
        }
        
        @media (min-width: 769px) and (max-width: 1400px) {
            .container {
                max-width: 100%;
                padding: var(--space-4);
            }
            
            .filters-panel, .results-panel {
                height: calc(100vh - 56px);
                max-height: calc(100vh - 56px);
            }
        }
        
        @media (min-width: 1401px) {
            .container {
                padding: var(--space-6);
            }
            
            .filters-panel, .results-panel {
                height: calc(100vh - 72px);
            }
        }
        
        /* Fullscreen mode fixes */
        @media (min-width: 1920px) {
            .container {
                max-width: none;
                padding: var(--space-8);
            }
            
            .filters-panel, .results-panel {
                height: calc(100vh - 96px);
            }
            
            .form-content {
                overflow-y: visible;
                overflow-x: visible;
            }
        }
        
        /* Force visibility for very large screens */
        @media (min-width: 2560px) {
            .filters-panel {
                min-height: calc(100vh - 96px);
                overflow: visible;
            }
            
            .form-content {
                overflow: visible;
                min-height: auto;
            }
            
            .custom-multiselect {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .action-buttons {
                flex-direction: column;
            }

            #leadsTable {
                font-size: var(--font-size-xs);
            }

            #leadsTable th,
            #leadsTable td {
                padding: var(--space-2);
                max-width: 120px;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: var(--space-2);
                gap: var(--space-3);
            }
            
            .filters-panel, .results-panel {
                padding: var(--space-3);
                height: auto;
                min-height: 300px;
            }
            
            .custom-multiselect {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: var(--space-1);
            }
            
            .option-chip {
                padding: var(--space-1) var(--space-2);
                min-height: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Filters Panel -->
        <div class="filters-panel">
            <div class="panel-header">
                <h1 class="panel-title">🎯 Lead Generation Filters</h1>
                <p class="panel-description">Configure your search criteria</p>
            </div>
            
            <form id="leadForm" class="form-content">
                <div class="form-group">
                    <div class="filter-card">
                        <label class="form-label required">
                            <span class="emoji">👔</span>
                            <span>Job Titles</span>
                        </label>
                        <div class="custom-multiselect" id="jobTitlesMultiselect">
                        <div class="multiselect-option" data-value="Owner">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-owner" name="jobTitle">
                                <label class="multiselect-label" for="job-owner">Owner</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="Founder">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-founder" name="jobTitle">
                                <label class="multiselect-label" for="job-founder">Founder</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="C suite">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-csuite" name="jobTitle">
                                <label class="multiselect-label" for="job-csuite">C suite</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="Partner">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-partner" name="jobTitle">
                                <label class="multiselect-label" for="job-partner">Partner</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="Vp">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-vp" name="jobTitle">
                                <label class="multiselect-label" for="job-vp">VP</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="Head">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-head" name="jobTitle">
                                <label class="multiselect-label" for="job-head">Head</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="Director">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-director" name="jobTitle">
                                <label class="multiselect-label" for="job-director">Director</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="Manager">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-manager" name="jobTitle">
                                <label class="multiselect-label" for="job-manager">Manager</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="Senior">
                            <div class="option-chip" onclick="toggleJobTitleOption(this)">
                                <input type="radio" class="multiselect-checkbox" id="job-senior" name="jobTitle">
                                <label class="multiselect-label" for="job-senior">Senior</label>
                            </div>
                        </div>
                        </div>
                        <div class="selection-preview" id="jobTitlesPreview">
                            <em style="color: var(--color-gray-400);">Select job titles above...</em>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="filter-card">
                        <label class="form-label required">
                            <span class="emoji">🏢</span>
                            <span>Company Size (Employees)</span>
                        </label>
                        <div class="custom-multiselect" id="companySizeMultiselect">
                        <div class="multiselect-option" data-value="1-10">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-1-10">
                                <label class="multiselect-label" for="size-1-10">1-10</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="11-20">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-11-20">
                                <label class="multiselect-label" for="size-11-20">11-20</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="21-50">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-21-50">
                                <label class="multiselect-label" for="size-21-50">21-50</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="51-100">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-51-100">
                                <label class="multiselect-label" for="size-51-100">51-100</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="101-200">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-101-200">
                                <label class="multiselect-label" for="size-101-200">101-200</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="201-500">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-201-500">
                                <label class="multiselect-label" for="size-201-500">201-500</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="501-1000">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-501-1000">
                                <label class="multiselect-label" for="size-501-1000">501-1K</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="1001-2000">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-1001-2000">
                                <label class="multiselect-label" for="size-1001-2000">1K-2K</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="2001-5000">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-2001-5000">
                                <label class="multiselect-label" for="size-2001-5000">2K-5K</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="5001-10000">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-5001-10000">
                                <label class="multiselect-label" for="size-5001-10000">5K-10K</label>
                            </div>
                        </div>
                        <div class="multiselect-option" data-value="10001+">
                            <div class="option-chip" onclick="toggleOption(this)">
                                <input type="checkbox" class="multiselect-checkbox" id="size-10001">
                                <label class="multiselect-label" for="size-10001">10K+</label>
                            </div>
                        </div>
                    </div>
                    <div class="selection-preview" id="companySizePreview">
                        <em style="color: var(--color-gray-400);">Select company sizes above...</em>
                    </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="filter-card">
                        <label class="form-label">
                            <span class="emoji">⚙️</span>
                            <span>Processing Options</span>
                        </label>
                        <div class="processing-options">
                            <div class="processing-row">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="generateOutreach" checked style="accent-color: var(--color-primary-500);">
                                    <label for="generateOutreach">🤖 Generate AI Outreach</label>
                                </div>
                            </div>
                            <div class="processing-row">
                                <div class="number-input-group">
                                    <label for="maxRecords">📊 Max Leads:</label>
                                    <input type="number" id="maxRecords" value="500" min="0" max="2000">
                                    <small style="color: var(--color-gray-500);">(0 = unlimited)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
            
            <div class="form-actions">
                <div class="action-buttons" style="margin-bottom: 0; gap: var(--space-3);">
                    <button type="button" class="btn btn-primary" id="generateUrlBtn" style="flex: 1;">
                        🔗 Generate Search Link
                    </button>
                    <button type="submit" class="submit-btn" id="generateBtn" style="flex: 2;" form="leadForm">
                        🚀 Generate & Process Leads
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="results-panel">
            <div class="panel-header">
                <h2 class="panel-title" id="resultsTitle">📊 Results & Logs</h2>
                <p class="panel-description" id="resultsDescription">Your generated leads will appear here</p>
            </div>
            
            <div class="results-empty-state" id="emptyState">
                <div class="icon">🎯</div>
                <h3>Ready to Generate Leads</h3>
                <p>Configure your filters on the left and click "Generate & Process Leads" to begin.</p>
            </div>
            
            <div class="output-section hidden" id="outputSection">
            
            <!-- Search URL Display -->
            <div id="urlSection" class="hidden">
                <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--space-3);">🔗 Generated Search URL</h3>
                <div class="search-url" id="searchUrl" style="background: var(--color-gray-50); padding: var(--space-4); border-radius: var(--border-radius-md); border: 1px solid var(--color-gray-200); font-family: monospace; word-break: break-all; font-size: var(--font-size-sm);"></div>
                <div class="action-buttons">
                    <button type="button" class="btn" id="copyBtn">📋 Copy URL</button>
                    <a href="#" class="btn btn-primary" id="openSearchBtn" target="_blank">🚀 Open Search</a>
                </div>
            </div>

            <!-- Leads Display -->
            <div id="leadsSection" class="hidden">
                <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--space-3);">📋 Generated Leads</h3>
                <div id="leadsStats" style="margin-bottom: var(--space-4);"></div>
                
                <!-- Leads Table -->
                <div style="overflow-x: auto; overflow-y: auto; max-height: 600px; border: 1px solid var(--color-gray-200); border-radius: var(--border-radius-md);">
                    <table id="leadsTable" style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm);">
                        <thead style="background: var(--color-gray-50);">
                            <tr>
                                <th style="padding: var(--space-3); text-align: left; border-bottom: 1px solid var(--color-gray-200);">Name</th>
                                <th style="padding: var(--space-3); text-align: left; border-bottom: 1px solid var(--color-gray-200);">Title</th>
                                <th style="padding: var(--space-3); text-align: left; border-bottom: 1px solid var(--color-gray-200);">Company</th>
                                <th style="padding: var(--space-3); text-align: left; border-bottom: 1px solid var(--color-gray-200);">Email</th>
                                <th style="padding: var(--space-3); text-align: left; border-bottom: 1px solid var(--color-gray-200);">LinkedIn</th>
                                <th style="padding: var(--space-3); text-align: left; border-bottom: 1px solid var(--color-gray-200);">Industry</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody"></tbody>
                    </table>
                </div>

                <div class="action-buttons" style="margin-top: var(--space-4);">
                    <button type="button" class="btn btn-success" id="downloadExcelBtn" disabled>
                        📊 Download Excel File
                    </button>
                    <button type="button" class="btn" id="viewOutreachBtn" style="display: none;">
                        💬 View Outreach Content
                    </button>
                </div>
            </div>
            
            
            <!-- Enhanced Processing Logs -->
            <div id="processingLogs" class="hidden">
                <div class="logs-section">
                    <div class="logs-header">
                        <h4 class="logs-title">
                            <span id="logsIcon">🔍</span>
                            <span>Processing Logs</span>
                            <span id="logCount" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: var(--font-size-xs);">0</span>
                            <span id="loadingTimer" class="hidden" style="background: rgba(255,255,255,0.15); padding: 2px 8px; border-radius: 12px; font-size: var(--font-size-xs); margin-left: 8px; color: rgba(255,255,255,0.9);">00:00</span>
                            <div id="logsLoader" class="logs-loader hidden" style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-left: auto;"></div>
                        </h4>
                        <div class="logs-controls">
                            <button id="toggleLogsBtn" class="logs-toggle" title="Expand/Collapse">⏷</button>
                            <button id="clearLogsBtn" class="logs-toggle" title="Clear Logs">🗑</button>
                            <button id="closeLogsBtn" class="logs-toggle" title="Close">✕</button>
                        </div>
                    </div>
                    <div id="logsContainer" class="logs-container">
                        <!-- Enhanced logs will appear here -->
                    </div>
                </div>
            </div>
            
            <div id="statusMessage"></div>
            </div>
        </div>
    </div>

    <script>
        // Global function for chip toggle
        // Global function for job title option clicking (single selection)
        function toggleJobTitleOption(chipElement) {
            const radio = chipElement.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Trigger change event for the lead generator to update previews
            radio.dispatchEvent(new Event('change'));
        }

        function toggleOption(chipElement) {
            const checkbox = chipElement.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                chipElement.classList.add('selected');
            } else {
                chipElement.classList.remove('selected');
            }
            
            // Trigger change event for the lead generator to update previews
            checkbox.dispatchEvent(new Event('change'));
        }
        
        class LeadGenerator {
            constructor() {
                this.form = document.getElementById('leadForm');
                this.outputSection = document.getElementById('outputSection');
                this.urlSection = document.getElementById('urlSection');
                this.leadsSection = document.getElementById('leadsSection');
                this.emptyState = document.getElementById('emptyState');
                
                this.generateUrlBtn = document.getElementById('generateUrlBtn');
                this.generateBtn = document.getElementById('generateBtn');
                this.copyBtn = document.getElementById('copyBtn');
                this.downloadExcelBtn = document.getElementById('downloadExcelBtn');
                this.viewOutreachBtn = document.getElementById('viewOutreachBtn');
                
                this.statusMessage = document.getElementById('statusMessage');
                this.processingLogs = document.getElementById('processingLogs');
                this.logsContainer = document.getElementById('logsContainer');
                
                this.jobTitlesMultiselect = document.getElementById('jobTitlesMultiselect');
                this.companySizeMultiselect = document.getElementById('companySizeMultiselect');
                this.jobTitlesPreview = document.getElementById('jobTitlesPreview');
                this.companySizePreview = document.getElementById('companySizePreview');
                
                this.currentLeads = null;
                
                // Timer properties
                this.startTime = null;
                this.timerInterval = null;
                
                this.bindEvents();
                this.updatePreviews(); // Initialize previews
            }

            bindEvents() {
                this.form.addEventListener('submit', (e) => this.handleCompleteWorkflow(e));
                this.generateUrlBtn.addEventListener('click', () => this.handleGenerateUrl());
                this.copyBtn.addEventListener('click', () => this.copyUrl());
                this.downloadExcelBtn.addEventListener('click', () => this.downloadExcel());
                this.viewOutreachBtn.addEventListener('click', () => this.viewOutreachContent());
                
                // Enhanced event listeners for log controls
                document.getElementById('closeLogsBtn').addEventListener('click', () => {
                    this.processingLogs.classList.add('hidden');
                });
                
                document.getElementById('clearLogsBtn').addEventListener('click', () => {
                    this.logsContainer.innerHTML = '';
                    this.updateLogCount(0);
                });
                
                document.getElementById('toggleLogsBtn').addEventListener('click', () => {
                    const container = this.logsContainer;
                    const button = document.getElementById('toggleLogsBtn');
                    const isCollapsed = container.style.maxHeight === '0px' || container.style.display === 'none';
                    
                    if (isCollapsed) {
                        container.style.maxHeight = '300px';
                        container.style.display = 'block';
                        button.textContent = '⏷';
                        button.title = 'Collapse';
                    } else {
                        container.style.maxHeight = '0px';
                        container.style.display = 'none';
                        button.textContent = '⏶';
                        button.title = 'Expand';
                    }
                });
                
                // Bind custom multiselect events
                this.bindMultiselectEvents();
            }

            bindMultiselectEvents() {
                // Job titles single select (radio buttons)
                const jobRadios = this.jobTitlesMultiselect.querySelectorAll('input[type="radio"]');
                jobRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.updateJobTitleSelection();
                        this.updatePreviews();
                    });
                });

                // Company size multiselect  
                const sizeCheckboxes = this.companySizeMultiselect.querySelectorAll('input[type="checkbox"]');
                sizeCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        this.updateMultiselectOption(checkbox.closest('.multiselect-option'));
                        this.updatePreviews();
                    });
                });
            }

            updateJobTitleSelection() {
                // Update visual state for all job title options
                const allOptions = this.jobTitlesMultiselect.querySelectorAll('.multiselect-option');
                allOptions.forEach(option => {
                    const radio = option.querySelector('input[type="radio"]');
                    const chip = option.querySelector('.option-chip');
                    
                    if (radio.checked) {
                        chip.classList.add('selected');
                    } else {
                        chip.classList.remove('selected');
                    }
                });
            }

            updateMultiselectOption(option) {
                const checkbox = option.querySelector('input[type="checkbox"]');
                const chip = option.querySelector('.option-chip');
                if (checkbox.checked) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            }

            updatePreviews() {
                // Update job titles preview (single selection)
                const selectedRadio = this.jobTitlesMultiselect.querySelector('input[type="radio"]:checked');
                if (selectedRadio) {
                    this.jobTitlesPreview.innerHTML = `Selected: ${selectedRadio.closest('.multiselect-option').dataset.value}`;
                } else {
                    this.jobTitlesPreview.innerHTML = '<em style="color: var(--color-gray-400);">Select a job title above...</em>';
                }

                // Update company sizes preview
                const selectedSizes = this.getSelectedValues(this.companySizeMultiselect);
                if (selectedSizes.length > 0) {
                    this.companySizePreview.innerHTML = `${selectedSizes.length} company size${selectedSizes.length > 1 ? 's' : ''} selected`;
                } else {
                    this.companySizePreview.innerHTML = '<em style="color: var(--color-gray-400);">Select company sizes above...</em>';
                }
            }

            getSelectedValues(multiselectElement) {
                const selectedOptions = multiselectElement.querySelectorAll('.multiselect-option input[type="checkbox"]:checked');
                return Array.from(selectedOptions).map(checkbox => 
                    checkbox.closest('.multiselect-option').getAttribute('data-value')
                );
            }

            handleGenerateUrl() {
                const { jobTitles, companySizes } = this.getFormData();
                if (!this.validateFormData(jobTitles, companySizes)) return;

                try {
                    this.showProgress('Generating search URL...');
                    
                    // Generate URL client-side (same logic as backend)
                    const searchUrl = this.generateSearchUrlClientSide(jobTitles, companySizes);
                    
                    this.displayUrl(searchUrl);
                    this.hideProgress();
                    this.showStatus('Search URL generated successfully!', 'success');

                } catch (error) {
                    this.hideProgress();
                    this.showStatus(`Error: ${error.message}`, 'error');
                }
            }

            generateSearchUrlClientSide(jobTitles, companySizes) {
                // Generate search URL with filters
                const baseUrl = "https://app.apollo.io/#/people?page=1";
                
                const defaultFilters = [
                    "contactEmailStatusV2[]=verified",
                    "existFields[]=person_title_normalized",
                    "existFields[]=organization_domain",
                    "personLocations[]=Singapore",
                    "personLocations[]=Singapore%2C%20Singapore",
                    "sortAscending=true",
                    "sortByField=sanitized_organization_name_unanalyzed"
                ];

                const titleFilters = jobTitles.map(title => 
                    `personTitles[]=${encodeURIComponent(title)}`
                );

                const sizeFilters = companySizes.map(size => {
                    const normalized = size.replace("-", ",");
                    return `organizationNumEmployeesRanges[]=${encodeURIComponent(normalized)}`;
                });

                const allFilters = [...defaultFilters, ...titleFilters, ...sizeFilters];
                return `${baseUrl}&${allFilters.join("&")}`;
            }

            async handleCompleteWorkflow(e) {
                e.preventDefault();
                
                const { jobTitles, companySizes, generateOutreach, maxRecords } = this.getFormData();
                if (!this.validateFormData(jobTitles, companySizes)) return;
                
                // Use streaming for better UX
                return this.handleStreamingWorkflow(jobTitles, companySizes, generateOutreach, maxRecords);
            }

            async handleStreamingWorkflow(jobTitles, companySizes, generateOutreach, maxRecords) {
                try {
                    this.showProgress('Starting background job...');
                    this.currentLeads = []; // Clear previous results
                    this.displayLeads([], {}); // Clear display
                    
                    // Start background job
                    const response = await fetch('/api/leads/start-workflow-job', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jobTitles,
                            companySizes,
                            generateOutreach,
                            maxRecords,
                            chunkSize: 100
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    const jobId = result.jobId;
                    
                    this.addLog(`✅ Background job started: ${jobId}`, 'success');
                    this.addLog('📡 Polling for progress updates...', 'info');
                    
                    // Start polling for job status
                    await this.pollJobStatus(jobId);
                    
                } catch (error) {
                    this.hideProgress();
                    console.error('Job creation error:', error);
                    
                    let errorMessage = 'Unknown error occurred';
                    
                    if (error.message.includes('429') || error.message.includes('Too Many Requests')) {
                        errorMessage = '⚠️ Rate limit exceeded. Please wait a few minutes before trying again.';
                    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        errorMessage = '🔌 Network connection failed. Please check your internet connection.';
                    } else if (error.message.includes('500')) {
                        errorMessage = '🔧 Server error. Please try again in a few minutes.';
                    } else {
                        errorMessage = `❌ ${error.message}`;
                    }
                    
                    this.addLog(`❌ Error: ${errorMessage}`, 'error');
                    this.showStatus(errorMessage, 'error');
                    
                    // Offer URL generation fallback
                    const searchUrl = this.generateSearchUrlClientSide(jobTitles, companySizes);
                    this.addLog(`🔧 Alternative: Use this Apollo URL manually: ${searchUrl}`, 'info');
                    document.getElementById('searchUrl').textContent = searchUrl;
                }
            }

            async pollJobStatus(jobId) {
                const maxWaitTime = 30 * 60 * 1000; // 30 minutes max
                const startTime = Date.now();
                let lastProgress = null;
                
                const poll = async () => {
                    try {
                        // Check if we've exceeded max wait time
                        if (Date.now() - startTime > maxWaitTime) {
                            throw new Error('Job exceeded maximum wait time (30 minutes)');
                        }
                        
                        const response = await fetch(`/api/leads/job-status/${jobId}`);
                        
                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error('Job not found or expired');
                            }
                            throw new Error(`Failed to check job status: ${response.status}`);
                        }
                        
                        const status = await response.json();
                        
                        // Update progress if changed
                        if (!lastProgress || JSON.stringify(status.progress) !== JSON.stringify(lastProgress)) {
                            this.updateJobProgress(status);
                            lastProgress = status.progress;
                        }
                        
                        if (status.isComplete) {
                            if (status.status === 'completed') {
                                await this.handleJobCompletion(jobId);
                            } else if (status.status === 'failed') {
                                throw new Error(status.error || 'Job failed');
                            }
                            return; // Stop polling
                        }
                        
                        // Continue polling every 3 seconds
                        setTimeout(poll, 3000);
                        
                    } catch (error) {
                        this.hideProgress();
                        console.error('Polling error:', error);
                        this.addLog(`❌ Job failed: ${error.message}`, 'error');
                        this.showStatus(`Job failed: ${error.message}`, 'error');
                    }
                };
                
                // Start polling
                poll();
            }

            updateJobProgress(status) {
                const progress = status.progress;
                
                // Update timer
                if (status.startTime) {
                    const elapsed = Date.now() - new Date(status.startTime).getTime();
                    const seconds = Math.floor(elapsed / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    const timeString = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                    
                    const loadingTimer = document.getElementById('loadingTimer');
                    if (loadingTimer) {
                        loadingTimer.textContent = timeString;
                    }
                }
                
                // Add progress log
                let message = progress.message;
                if (progress.chunk && progress.totalChunks) {
                    message += ` (${progress.chunk}/${progress.totalChunks})`;
                }
                if (progress.elapsed) {
                    const minutes = Math.floor(progress.elapsed / 60);
                    const seconds = progress.elapsed % 60;
                    const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                    message += ` - ${timeStr} elapsed`;
                }
                
                this.addLog(`🔄 ${message}`, 'info');
            }

            async handleJobCompletion(jobId) {
                try {
                    // Get the final result with leads data
                    const response = await fetch(`/api/leads/job-result/${jobId}`);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to retrieve job result: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    this.hideProgress();
                    
                    if (!result.leads || result.leads.length === 0) {
                        this.showStatus('No leads found for the specified criteria. Try adjusting your filters.', 'info');
                        return;
                    }
                    
                    // Store and display results
                    this.currentLeads = result.leads;
                    this.displayLeads(result.leads, result.metadata);
                    
                    const successMsg = `🎉 Successfully loaded ${result.leads.length} leads!`;
                    this.addLog(successMsg, 'success');
                    this.showStatus(successMsg, 'success');
                    
                    // Show completion time
                    const loadingTimer = document.getElementById('loadingTimer');
                    if (loadingTimer) {
                        const finalTime = loadingTimer.textContent;
                        this.addLog(`⏱️ Total processing time: ${finalTime}`, 'info');
                    }
                    
                } catch (error) {
                    this.hideProgress();
                    console.error('Job completion error:', error);
                    this.addLog(`❌ Failed to retrieve results: ${error.message}`, 'error');
                    this.showStatus(`Failed to retrieve results: ${error.message}`, 'error');
                }
            }

            handleStreamEvent(eventType, data, allLeads, metadata) {
                switch(eventType) {
                    case 'progress':
                        // Make progress messages generic
                        let genericMessage = data.message;
                        if (genericMessage.includes('Apollo')) {
                            genericMessage = genericMessage.replace(/Apollo/g, 'database');
                        }
                        this.updateProgress(`Step ${data.step}/${data.total}: ${genericMessage}`);
                        this.addLog(`📋 ${genericMessage}`, 'progress');
                        break;
                        
                    case 'scraped':
                        // Merge scraped metadata while preserving form data
                        Object.assign(metadata, data.metadata);
                        this.updateProgress(`✅ Found ${data.count} leads from database`);
                        this.addLog(`🔍 Lead search completed - ${data.count} leads found`, 'progress');
                        if (data.metadata?.duplicatesRemoved > 0) {
                            this.addLog(`🧹 Removed ${data.metadata.duplicatesRemoved} duplicate records`, 'info');
                        }
                        break;
                        
                    case 'chunk_start':
                        this.updateProgress(`🔄 Processing batch ${data.chunk}/${data.total} (${data.size} leads)...`);
                        this.addLog(`📦 Starting batch ${data.chunk}/${data.total} - processing ${data.size} leads`, 'processing');
                        break;
                        
                    case 'chunk_complete':
                        // Add new leads to collection
                        allLeads.push(...data.leads);
                        this.currentLeads = allLeads;
                        
                        // Add detailed logs for each lead
                        data.leads.forEach((lead, index) => {
                            const leadNum = data.processed - data.leads.length + index + 1;
                            const outreachStatus = lead.outreach_generated ? '✅ AI content generated' : '⚪ No outreach';
                            this.addLog(`Processing lead ${leadNum}/${data.processed + data.remaining}: ${lead.name} - ${outreachStatus}`, 'processing');
                        });
                        
                        // Update display with all leads so far
                        this.displayLeads(allLeads, metadata);
                        
                        // Update progress
                        const progressMsg = `📦 Loaded ${data.processed} leads (batch ${data.chunk}/${data.total})`;
                        this.updateProgress(progressMsg);
                        this.addLog(`✅ Batch ${data.chunk} completed - ${data.processed}/${data.processed + data.remaining} total leads processed`, 'progress');
                        
                        // Show live count
                        this.showStatus(`Loading... ${data.processed}/${data.processed + data.remaining} leads processed`, 'info');
                        break;
                        
                    case 'complete':
                        // Calculate total time taken
                        const totalTime = this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0;
                        const minutes = Math.floor(totalTime / 60);
                        const seconds = totalTime % 60;
                        const timeString = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                        
                        // Merge final metadata and display
                        Object.assign(metadata, data.metadata);
                        this.displayLeads(allLeads, metadata);
                        this.addLog(`🎉 Workflow completed successfully - ${data.count} leads generated in ${timeString}`, 'progress');
                        this.showStatus(`🎉 Successfully loaded ${data.count} leads in ${timeString}!`, 'success');
                        break;
                        
                    case 'error':
                        this.addLog(`❌ Error: ${data.message}`, 'error');
                        this.showStatus(`Error: ${data.message}`, 'error');
                        break;
                }
            }

            getFormData() {
                // Get single job title selection
                const selectedJobTitle = this.jobTitlesMultiselect.querySelector('input[type="radio"]:checked');
                const jobTitles = selectedJobTitle ? [selectedJobTitle.closest('.multiselect-option').dataset.value] : [];
                
                const companySizes = this.getSelectedValues(this.companySizeMultiselect);
                const generateOutreach = document.getElementById('generateOutreach').checked;
                const maxRecords = parseInt(document.getElementById('maxRecords').value) || 0;
                
                return { jobTitles, companySizes, generateOutreach, maxRecords };
            }

            validateFormData(jobTitles, companySizes) {
                if (jobTitles.length === 0) {
                    this.showStatus('Please select a job title.', 'error');
                    return false;
                }
                if (companySizes.length === 0) {
                    this.showStatus('Please select at least one company size.', 'error');
                    return false;
                }
                
                // Show selection summary for confirmation
                const summary = `Selected: ${jobTitles.length} job title(s), ${companySizes.length} company size(s)`;
                console.log('Filter Summary:', summary);
                
                return true;
            }

            displayUrl(searchUrl) {
                document.getElementById('searchUrl').textContent = searchUrl;
                document.getElementById('openSearchBtn').href = searchUrl;
                
                this.emptyState.classList.add('hidden');
                this.outputSection.classList.remove('hidden');
                this.urlSection.classList.remove('hidden');
                this.leadsSection.classList.add('hidden');
                
                // Make header compact when showing results
                const panelHeader = document.querySelector('.panel-header');
                panelHeader.classList.add('compact');
                
                // Update results panel header - keep it simple
                document.getElementById('resultsTitle').textContent = '📊 Results & Logs';
                document.getElementById('resultsDescription').textContent = 'Your search URL is ready';
            }

            displayLeads(leads, metadata) {
                // Hide empty state and show results
                this.emptyState.classList.add('hidden');
                this.outputSection.classList.remove('hidden');
                this.leadsSection.classList.remove('hidden');
                this.urlSection.classList.add('hidden');
                
                // Make header compact when showing results
                const panelHeader = document.querySelector('.panel-header');
                panelHeader.classList.add('compact');
                
                // Update results panel header - keep it simple without lead count
                document.getElementById('resultsTitle').textContent = `📊 Results & Logs`;
                document.getElementById('resultsDescription').textContent = 'Your generated leads';
                
                // Update stats
                const stats = document.getElementById('leadsStats');
                const outreachCount = leads.filter(lead => lead.outreach_generated).length;
                
                // Enhanced statistics from scrapeMetadata
                const totalAvailable = metadata.scrapeMetadata?.totalAvailable || metadata.totalFound || leads.length;
                const rawScraped = metadata.scrapeMetadata?.rawScraped || leads.length;
                const duplicatesRemoved = metadata.scrapeMetadata?.duplicatesRemoved || 0;
                const finalCount = metadata.scrapeMetadata?.finalCount || leads.length;
                const limitReached = metadata.scrapeMetadata?.limitReached || false;
                const deduplicationRate = metadata.scrapeMetadata?.deduplicationStats?.deduplicationRate || '0%';
                
                // Show applied filters - handle undefined arrays safely
                const jobTitles = metadata.jobTitles || [];
                const companySizes = metadata.companySizes || [];
                
                // Enhanced statistics display
                const limitDisplay = metadata.maxRecords === 0 || metadata.maxRecords === 'unlimited' ? 'No Limit' : `${metadata.maxRecords} records`;
                
                const filtersDisplay = jobTitles.length > 0 || companySizes.length > 0 ? `
                    <div style="margin-bottom: var(--space-3); padding: var(--space-3); background: var(--color-gray-50); border-radius: var(--border-radius-md);">
                        <strong>Applied Filters:</strong>
                        <div style="margin-top: var(--space-2);">
                            <span style="font-size: var(--font-size-sm);">
                                ${jobTitles.length > 0 ? `<strong>Job Titles:</strong> ${jobTitles.join(', ')} | ` : ''}
                                ${companySizes.length > 0 ? `<strong>Company Sizes:</strong> ${companySizes.join(', ')} | ` : ''}
                                <strong>Location:</strong> Singapore | 
                                <strong>Record Limit:</strong> ${limitDisplay}${metadata.outreachGenerated ? ` | <strong>AI Outreach:</strong> ${outreachCount}` : ''}
                            </span>
                        </div>
                    </div>
                ` : '';
                
                // Duplicate removal stats
                const duplicationDisplay = duplicatesRemoved > 0 ? 
                    `<div style="color: var(--color-green-600);"><strong>🧹 Duplicates Removed:</strong> ${duplicatesRemoved} (${deduplicationRate})</div>` : 
                    '';
                
                stats.innerHTML = filtersDisplay + `
                    <!-- Main Statistics - Single Row Layout -->
                    <div style="display: flex; gap: var(--space-3); margin-bottom: var(--space-4); flex-wrap: nowrap; overflow-x: auto;">
                        <div class="stats-card" style="flex: 1; min-width: 120px; padding: var(--space-3); background: linear-gradient(135deg, var(--color-blue-50) 0%, var(--color-white) 100%); border-radius: var(--border-radius-lg); border: 1px solid var(--color-blue-200); text-align: center; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);">
                            <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-blue-700); margin-bottom: var(--space-1);">${totalAvailable.toLocaleString()}</div>
                            <div style="font-size: var(--font-size-xs); color: var(--color-blue-600); font-weight: var(--font-weight-medium);">Total Available</div>
                        </div>
                        <div class="stats-card" style="flex: 1; min-width: 120px; padding: var(--space-3); background: linear-gradient(135deg, var(--color-green-50) 0%, var(--color-white) 100%); border-radius: var(--border-radius-lg); border: 1px solid var(--color-green-200); text-align: center; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.1);">
                            <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-green-700); margin-bottom: var(--space-1);">${finalCount.toLocaleString()}</div>
                            <div style="font-size: var(--font-size-xs); color: var(--color-green-600); font-weight: var(--font-weight-medium);">Final Results</div>
                        </div>
                        <div class="stats-card" style="flex: 1; min-width: 120px; padding: var(--space-3); background: linear-gradient(135deg, var(--color-purple-50) 0%, var(--color-white) 100%); border-radius: var(--border-radius-lg); border: 1px solid var(--color-purple-300); text-align: center; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.1);">
                            <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-purple-700); margin-bottom: var(--space-1);">${leads.filter(l => l.email).length}</div>
                            <div style="font-size: var(--font-size-xs); color: var(--color-purple-600); font-weight: var(--font-weight-medium);">With Email</div>
                        </div>
                        <div class="stats-card" style="flex: 1; min-width: 120px; padding: var(--space-3); background: linear-gradient(135deg, var(--color-indigo-50) 0%, var(--color-white) 100%); border-radius: var(--border-radius-lg); border: 1px solid var(--color-indigo-300); text-align: center; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);">
                            <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-indigo-700); margin-bottom: var(--space-1);">${leads.filter(l => l.linkedin_url).length}</div>
                            <div style="font-size: var(--font-size-xs); color: var(--color-indigo-600); font-weight: var(--font-weight-medium);">With LinkedIn</div>
                        </div>
                    </div>
                    
                    <!-- Processing Details -->
                    ${duplicatesRemoved > 0 ? `
                        <div style="display: flex; gap: var(--space-6); flex-wrap: wrap; font-size: var(--font-size-sm); color: var(--color-gray-600);">
                            <div><strong>Raw Scraped:</strong> ${rawScraped.toLocaleString()}</div>
                            ${duplicationDisplay}
                        </div>
                    ` : ''}
                    
                `;

                // Update table
                const tbody = document.getElementById('leadsTableBody');
                tbody.innerHTML = leads.map(lead => `
                    <tr>
                        <td title="${lead.name || ''}">${lead.name || 'N/A'}</td>
                        <td title="${lead.title || ''}">${lead.title || 'N/A'}</td>
                        <td title="${lead.organization_name || ''}">${lead.organization_name || 'N/A'}</td>
                        <td title="${lead.email || ''}">${lead.email || 'N/A'}</td>
                        <td title="${lead.linkedin_url || ''}">
                            ${lead.linkedin_url ? `<a href="${lead.linkedin_url}" target="_blank" style="color: var(--color-primary-600);">View Profile</a>` : 'N/A'}
                        </td>
                        <td title="${lead.industry || ''}">${lead.industry || 'N/A'}</td>
                    </tr>
                `).join('');

                // Enable download button when leads are loaded
                this.downloadExcelBtn.disabled = false;
                
                // Show/hide outreach button
                if (metadata.outreachGenerated && outreachCount > 0) {
                    this.viewOutreachBtn.style.display = 'inline-flex';
                }
            }

            copyUrl() {
                const url = document.getElementById('searchUrl').textContent;
                navigator.clipboard.writeText(url).then(() => {
                    this.showStatus('URL copied to clipboard!', 'success');
                }).catch(() => {
                    this.showStatus('Failed to copy URL', 'error');
                });
            }

            async downloadExcel() {
                if (!this.currentLeads) {
                    this.showStatus('No leads data available', 'error');
                    return;
                }

                try {
                    this.showStatus('Generating Excel file...', 'info');
                    
                    const response = await fetch('/api/leads/export-excel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ leads: this.currentLeads })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Export failed');
                    }

                    // Download the file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'leads.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    this.showStatus('Excel file downloaded successfully!', 'success');

                } catch (error) {
                    this.showStatus(`Export error: ${error.message}`, 'error');
                }
            }

            viewOutreachContent() {
                if (!this.currentLeads) return;

                const leadsWithOutreach = this.currentLeads.filter(lead => lead.notes && lead.outreach_generated);
                
                if (leadsWithOutreach.length === 0) {
                    this.showStatus('No outreach content available', 'info');
                    return;
                }

                // Create modal to display outreach content
                const modal = document.createElement('div');
                modal.id = 'outreachModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.5); z-index: 1000; 
                    display: flex; align-items: center; justify-content: center;
                    padding: var(--space-4);
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white; max-width: 800px; max-height: 80vh; 
                    overflow-y: auto; border-radius: var(--border-radius-xl);
                    padding: var(--space-6);
                `;

                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                        <h3>AI-Generated Outreach Content</h3>
                        <button id="closeModalBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;">&times;</button>
                    </div>
                    ${leadsWithOutreach.map(lead => `
                        <div style="border: 1px solid var(--color-gray-200); border-radius: var(--border-radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
                            <h4 style="margin-bottom: var(--space-2);">${lead.name} - ${lead.organization_name}</h4>
                            <pre style="white-space: pre-wrap; font-family: var(--font-family); font-size: var(--font-size-sm);">${lead.notes}</pre>
                        </div>
                    `).join('')}
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Add event listener for modal close button
                document.getElementById('closeModalBtn').addEventListener('click', () => {
                    modal.remove();
                });
            }

            showProgress(message) {
                this.processingLogs.classList.remove('hidden');
                this.outputSection.classList.remove('hidden');
                this.generateBtn.disabled = true;
                this.generateUrlBtn.disabled = true;
                this.downloadExcelBtn.disabled = true; // Disable download button
                
                // Show loading icon and update icon
                this.showLoadingState(true);
                
                // Clear previous results and logs for fresh start
                this.logsContainer.innerHTML = '';
                this.updateLogCount(0);
                this.currentLeads = [];
                this.displayLeads([], {}); // Clear previous results table
                this.leadsSection.classList.add('hidden'); // Hide results until new data comes
                
                this.addLog('🚀 Starting lead generation workflow...', 'info');
            }

            updateProgress(step) {
                // Just log the progress step now
                this.addLog(step, 'progress');
            }

            hideProgress() {
                // Keep processing logs visible after completion
                // User can manually close them
                this.generateBtn.disabled = false;
                this.generateUrlBtn.disabled = false;
                
                // Hide loading state
                this.showLoadingState(false);
                
                // Enable download button only if we have leads
                if (this.currentLeads && this.currentLeads.length > 0) {
                    this.downloadExcelBtn.disabled = false;
                }
            }

            showLoadingState(isLoading) {
                const logsIcon = document.getElementById('logsIcon');
                const logsLoader = document.getElementById('logsLoader');
                const loadingTimer = document.getElementById('loadingTimer');
                
                if (isLoading) {
                    logsIcon.textContent = '⟳'; // Spinning icon
                    logsLoader.classList.remove('hidden');
                    
                    // Start timer
                    this.startTimer();
                    loadingTimer.classList.remove('hidden');
                } else {
                    logsIcon.textContent = '🔍'; // Search icon
                    logsLoader.classList.add('hidden');
                    
                    // Stop timer
                    this.stopTimer();
                    loadingTimer.classList.add('hidden');
                }
            }

            startTimer() {
                this.startTime = Date.now();
                const loadingTimer = document.getElementById('loadingTimer');
                
                // Clear any existing interval
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                
                // Update timer every second
                this.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - this.startTime;
                    const seconds = Math.floor(elapsed / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    
                    const timeString = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                    loadingTimer.textContent = timeString;
                }, 1000);
                
                // Set initial time
                loadingTimer.textContent = '00:00';
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                // Show final time for a few seconds
                const loadingTimer = document.getElementById('loadingTimer');
                const finalTime = loadingTimer.textContent;
                
                setTimeout(() => {
                    loadingTimer.textContent = '00:00';
                }, 3000); // Show final time for 3 seconds
            }
            
            addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                const icons = {
                    info: 'ℹ',
                    progress: '✓',
                    error: '✕',
                    warning: '⚠',
                    processing: '⟳'
                };
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">${timestamp}</span>
                    <div class="log-icon ${type}">${icons[type] || icons.info}</div>
                    <div class="log-message ${type}">${message}</div>
                `;
                
                this.logsContainer.appendChild(logEntry);
                this.logsContainer.scrollTop = this.logsContainer.scrollHeight;
                
                // Update log count
                this.updateLogCount(this.logsContainer.children.length);
            }

            updateLogCount(count) {
                const logCountElement = document.getElementById('logCount');
                if (logCountElement) {
                    logCountElement.textContent = count;
                }
            }

            showStatus(message, type) {
                const statusClass = type === 'info' ? 'status-enhanced status-info' : `status-message status-${type}`;
                this.statusMessage.innerHTML = `<div class="${statusClass}">${message}</div>`;
                setTimeout(() => {
                    this.statusMessage.innerHTML = '';
                }, 5000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new LeadGenerator();
        });
    </script>
</body>
</html>