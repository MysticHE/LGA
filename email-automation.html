<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Automation - LGA</title>
    <link rel="stylesheet" href="styles/email-automation.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="nav-container">
            <div class="nav-title">Lead Generation Automation</div>
            <div class="nav-links">
                <a href="/" class="nav-link">Lead Scraping</a>
                <a href="/email-automation" class="nav-link active">Email Automation</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Authentication Status -->
        <div id="authStatus" class="auth-status hidden">
            <div id="authMessage"></div>
        </div>

        <!-- Dashboard Stats -->
        <div class="card full-width">
            <div class="card-header">
                <h2 class="card-title" data-icon="üìä">Email Automation Dashboard</h2>
                <div class="flex gap-sm">
                    <button class="btn" onclick="refreshDashboard()" title="Refresh Dashboard Data">
                        üîÑ Refresh
                    </button>
                    <button class="btn btn-outline" onclick="showInsights()" title="View Analytics">
                        üìà Insights
                    </button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card" onclick="showLeadDetails('total')" title="Click to view all leads">
                    <div class="stat-number" id="totalLeads">-</div>
                    <div class="stat-label">Total Leads</div>
                </div>
                <div class="stat-card" onclick="showLeadDetails('due')" title="Click to view leads due today">
                    <div class="stat-number" id="dueToday">-</div>
                    <div class="stat-label">Due Today</div>
                </div>
                <div class="stat-card" onclick="showEmailStats('sent')" title="Click to view sent email details">
                    <div class="stat-number" id="emailsSent">-</div>
                    <div class="stat-label">Emails Sent</div>
                </div>
                <div class="stat-card" onclick="showEmailStats('read')" title="Click to view read email details">
                    <div class="stat-number" id="emailsRead">-</div>
                    <div class="stat-label">Emails Read</div>
                </div>
                <div class="stat-card" onclick="showEmailStats('replies')" title="Click to view replies">
                    <div class="stat-number" id="repliesReceived">-</div>
                    <div class="stat-label">Replies Received</div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Upload Section -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-icon="üì§">Upload Lead List</h3>
                    <div>
                        <span id="uploadAuthStatus" class="auth-status" style="margin-right: 10px;">üîÑ Checking...</span>
                        <button class="btn btn-outline" onclick="showUploadHelp()" title="Upload Help">
                            ‚ùì Help
                        </button>
                    </div>
                </div>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Click or drag Excel file here</div>
                    <div class="upload-subtext">Supports .xlsx files up to 10MB</div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" />
                </div>
                <div id="uploadProgress" class="hidden">
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div id="uploadStatus" class="text-center"></div>
                </div>
                <div id="uploadResults" class="hidden">
                    <div class="flex-between mb-lg">
                        <h4>üìä Upload Results</h4>
                        <button class="btn btn-success" onclick="viewMasterList()" title="View Updated Master List">
                            üëÅÔ∏è View List
                        </button>
                    </div>
                    <div id="uploadSummary"></div>
                </div>
            </div>

            <!-- Template Management -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-icon="üìù">Email Templates</h3>
                    <div class="flex gap-sm">
                        <button class="btn" onclick="loadTemplates()" title="Refresh Templates">
                            üîÑ Refresh
                        </button>
                        <button class="btn btn-success" onclick="openTemplateModal()" title="Create New Template">
                            ‚ûï New Template
                        </button>
                    </div>
                </div>
                <div id="templatesList">
                    <div class="flex-center">
                        <div class="spinner"></div>
                        <span class="ml-md">Loading templates...</span>
                    </div>
                </div>
                <div class="mt-lg">
                    <div class="flex-between">
                        <div class="template-stats" id="templateStats">
                            <span class="text-muted">0 templates</span>
                        </div>
                        <button class="btn btn-outline" onclick="importTemplates()" title="Import Templates">
                            üì• Import
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Management -->
        <div class="card full-width">
            <div class="card-header">
                <h3 class="card-title" data-icon="üöÄ">Campaign Management</h3>
                <div class="flex gap-sm">
                    <button class="btn" onclick="showCampaignHistory()" title="View Campaign History">
                        üìà History
                    </button>
                    <button class="btn btn-success" onclick="openCampaignModal()" title="Start New Campaign">
                        üöÄ Start Campaign
                    </button>
                </div>
            </div>
            <div class="campaign-actions-grid">
                <div class="action-group">
                    <h4>üìã Quick Actions</h4>
                    <div class="action-buttons">
                        <button class="btn" onclick="showDueLeads()" title="View leads due for email today">
                            üìÖ View Due Today
                        </button>
                        <button class="btn btn-warning" onclick="showScheduledCampaigns()" title="View and manage scheduled campaigns">
                            ‚è∞ Scheduled Campaigns
                        </button>
                        <button class="btn" onclick="viewMasterList()" title="View complete master list">
                            üìã View Master List
                        </button>
                        <button class="btn btn-outline" onclick="bulkActions()" title="Perform bulk actions">
                            üì¶ Bulk Actions
                        </button>
                    </div>
                </div>
                <div class="action-group">
                    <h4>‚öôÔ∏è Automation Settings</h4>
                    <div class="action-buttons">
                        <button class="btn" onclick="openAutomationSettings()" title="Configure automation rules">
                            ‚öôÔ∏è Configure Rules
                        </button>
                        <button class="btn btn-warning" onclick="pauseAutomation()" title="Pause all automated campaigns">
                            ‚è∏Ô∏è Pause All
                        </button>
                        <button class="btn btn-success" onclick="resumeAutomation()" title="Resume all automated campaigns">
                            ‚ñ∂Ô∏è Resume All
                        </button>
                        <button class="btn btn-outline" onclick="viewAutomationLogs()" title="View automation activity logs">
                            üìã View Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Master List Table -->
        <div class="card full-width">
            <div class="card-header">
                <h3 class="card-title" data-icon="üìã">Master Lead List</h3>
                <div class="flex gap-sm">
                    <div class="flex gap-sm">
                        <input type="text" id="searchLeads" class="form-input search-input" placeholder="üîç Search leads...">
                        <select id="filterStatus" class="form-select filter-select">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="sent">Sent</option>
                            <option value="read">Read</option>
                            <option value="replied">Replied</option>
                        </select>
                    </div>
                    <div class="flex gap-sm">
                        <button class="btn btn-outline" onclick="exportMasterList()" title="Export to Excel">
                            üì• Export Excel
                        </button>
                        <button class="btn" onclick="loadMasterList()" title="Refresh master list">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats Bar -->
            <div class="flex-between mb-lg" id="listStats">
                <div class="flex gap-md">
                    <span class="text-muted">Showing: <strong id="showingCount">0</strong> of <strong id="totalCount">0</strong> leads</span>
                </div>
                <div class="flex gap-sm">
                    <button class="btn btn-outline" onclick="selectAllLeads()" title="Select all visible leads">
                        ‚òëÔ∏è Select All
                    </button>
                    <button class="btn btn-outline" onclick="clearSelection()" title="Clear selection">
                        üîÑ Clear
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table" id="masterListTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Company</th>
                            <th>Status</th>
                            <th>Campaign Stage</th>
                            <th>Email Choice</th>
                            <th>Last Email</th>
                            <th>Next Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="masterListBody">
                        <tr>
                            <td colspan="10" class="text-center loading-cell">
                                <div class="flex-center">
                                    <div class="spinner"></div>
                                    <span class="ml-md">Loading master list...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex-between mt-lg" id="pagination">
                <div class="flex gap-sm">
                    <span class="text-muted">Items per page:</span>
                    <select id="itemsPerPage" class="form-select pagination-select" onchange="changeItemsPerPage()">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="flex gap-sm" id="paginationControls">
                    <!-- Pagination controls will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìù Email Template Editor</h2>
                <span class="close" onclick="closeTemplateModal()">&times;</span>
            </div>
            <form id="templateForm">
                <div class="form-group">
                    <label class="form-label">Template Name:</label>
                    <input type="text" id="templateName" class="form-input" placeholder="e.g., First Contact Template" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Template Type:</label>
                    <select id="templateType" class="form-select" required>
                        <option value="">Select type...</option>
                        <option value="First_Contact">First Contact</option>
                        <option value="Follow_Up">Follow Up</option>
                        <option value="Nurture">Nurture</option>
                        <option value="Re_Engagement">Re-engagement</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Subject Line:</label>
                    <input type="text" id="templateSubject" class="form-input" placeholder="Use {Name}, {Company}, {Title} for personalization" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Content:</label>
                    <textarea id="templateContent" class="form-textarea" placeholder="Use {Name}, {Company}, {Title} for personalization" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Active:</label>
                    <select id="templateActive" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="previewTemplate()">üëÅÔ∏è Preview</button>
                    <button type="submit" class="btn btn-success">üíæ Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Campaign Modal -->
    <div id="campaignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üöÄ Start Email Campaign</h2>
                <span class="close" onclick="closeCampaignModal()">&times;</span>
            </div>
            <form id="campaignForm">
                <div class="form-group">
                    <label class="form-label">Campaign Name:</label>
                    <input type="text" id="campaignName" class="form-input" placeholder="e.g., January 2025 Outreach" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Content Type:</label>
                    <select id="emailContentType" class="form-select" required>
                        <option value="">Select content type...</option>
                        <option value="AI_Generated">AI-Generated (Personalized)</option>
                        <option value="Email_Template_1">Email Template 1</option>
                        <option value="Email_Template_2">Email Template 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Target Leads:</label>
                    <select id="targetLeads" class="form-select" required>
                        <option value="new">New Leads Only</option>
                        <option value="due">Due Today</option>
                        <option value="all_new">All New + Due</option>
                        <option value="custom">Custom Selection</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Send Schedule:</label>
                    <select id="sendSchedule" class="form-select" required>
                        <option value="immediate">Send Immediately</option>
                        <option value="scheduled">Schedule for Later</option>
                    </select>
                </div>
                <div id="scheduleDateTime" class="form-group hidden">
                    <label class="form-label">Schedule Date & Time:</label>
                    <input type="datetime-local" id="scheduledTime" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-up Days:</label>
                    <input type="number" id="followUpDays" class="form-input" value="7" min="1" max="30" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="previewCampaign()">üëÅÔ∏è Preview</button>
                    <button type="submit" class="btn btn-success">üöÄ Start Campaign</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let sessionId = null;
        let masterListData = [];
        let templates = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeEmailAutomation();
            setupEventListeners();
        });

        // Initialize authentication and load data
        async function initializeEmailAutomation() {
            console.log('üöÄ Initializing Email Automation...');
            
            try {
                // Check if we have a sessionId from URL parameters (after auth callback)
                const urlParams = new URLSearchParams(window.location.search);
                const urlSessionId = urlParams.get('sessionId');
                
                if (urlSessionId) {
                    sessionId = urlSessionId;
                    // Remove sessionId from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // Check authentication status
                const authUrl = sessionId ? `/auth/status?sessionId=${sessionId}` : '/auth/status';
                const authResponse = await fetch(authUrl);
                const authData = await authResponse.json();
                
                if (authData.authenticated) {
                    sessionId = authData.sessionId;
                    showAuthStatus('‚úÖ Connected to Microsoft 365', 'success');
                    
                    // Load initial data
                    await Promise.all([
                        refreshDashboard(),
                        loadTemplates(),
                        loadMasterList()
                    ]);
                } else {
                    // No authentication - need to initiate Microsoft 365 login
                    showAuthStatus('üîë Connecting to Microsoft 365...', 'info');
                    
                    // Initiate authentication
                    console.log('üîç Attempting to initiate Microsoft 365 login...');
                    const loginResponse = await fetch('/auth/login?redirect=/email-automation');
                    
                    console.log('üì° Login response status:', loginResponse.status);
                    
                    if (!loginResponse.ok) {
                        const errorText = await loginResponse.text();
                        console.error('‚ùå Login endpoint error:', errorText);
                        showAuthStatus(`‚ùå Login service unavailable (${loginResponse.status})`, 'error');
                        return;
                    }
                    
                    const loginData = await loginResponse.json();
                    console.log('üìã Login response data:', loginData);
                    
                    if (loginData.success && loginData.authUrl) {
                        showAuthStatus('üîë Redirecting to Microsoft 365 login...', 'info');
                        console.log('üöÄ Redirecting to:', loginData.authUrl);
                        
                        // Store sessionId and redirect to Microsoft auth
                        sessionStorage.setItem('pendingSessionId', loginData.sessionId);
                        window.location.href = loginData.authUrl;
                    } else {
                        console.error('‚ùå Login failed:', loginData);
                        showAuthStatus(`‚ùå Failed to initiate Microsoft 365 login: ${loginData.message || 'Unknown error'}`, 'error');
                    }
                }
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                showAuthStatus('‚ùå Failed to connect to Microsoft 365. Please try again.', 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // File upload
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.upload-area');
            
            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileUpload();
                }
            });

            // Forms
            document.getElementById('templateForm').addEventListener('submit', saveTemplate);
            document.getElementById('campaignForm').addEventListener('submit', startCampaign);
            
            // Modal close on background click
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // Email content type change
            document.getElementById('emailContentType').addEventListener('change', function() {
                updateCampaignPreview();
            });

            // Send schedule change
            document.getElementById('sendSchedule').addEventListener('change', function() {
                const scheduleDiv = document.getElementById('scheduleDateTime');
                if (this.value === 'scheduled') {
                    scheduleDiv.classList.remove('hidden');
                } else {
                    scheduleDiv.classList.add('hidden');
                }
            });

            // Search and filter functionality
            document.getElementById('searchLeads').addEventListener('input', function() {
                filterMasterList();
            });

            document.getElementById('filterStatus').addEventListener('change', function() {
                filterMasterList();
            });
        }

        // Show authentication status
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            const messageDiv = document.getElementById('authMessage');
            
            statusDiv.className = `auth-status auth-${type}`;
            messageDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            // Update upload auth status indicator
            const uploadAuthStatus = document.getElementById('uploadAuthStatus');
            if (uploadAuthStatus) {
                if (type === 'success') {
                    uploadAuthStatus.innerHTML = '‚úÖ Ready';
                    uploadAuthStatus.style.color = '#10b981';
                } else if (type === 'info') {
                    uploadAuthStatus.innerHTML = 'üîÑ Connecting...';
                    uploadAuthStatus.style.color = '#3b82f6';
                } else {
                    uploadAuthStatus.innerHTML = '‚ùå Not Connected';
                    uploadAuthStatus.style.color = '#ef4444';
                }
            }
        }

        // Handle file upload
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            // Check authentication first
            if (!sessionId) {
                document.getElementById('uploadSummary').innerHTML = `
                    <strong>üîë Authentication Required</strong><br>
                    Please connect to Microsoft 365 first.<br>
                    <button onclick="initializeEmailAutomation()" class="btn btn-primary" style="margin-top: 10px;">Connect Now</button>
                `;
                document.getElementById('uploadResults').classList.remove('hidden');
                return;
            }
            
            console.log('üì§ Uploading file:', file.name);
            
            // Show progress
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadResults').classList.add('hidden');
            
            const formData = new FormData();
            formData.append('excelFile', file);
            
            try {
                const response = await fetch('/api/email-automation/master-list/upload', {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': sessionId
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show results
                    document.getElementById('uploadSummary').innerHTML = `
                        <strong>‚úÖ Upload Completed</strong><br>
                        üìä Total Processed: ${result.totalProcessed}<br>
                        ‚ú® New Leads Added: ${result.newLeads}<br>
                        üîÑ Duplicates Skipped: ${result.duplicates}
                    `;
                    
                    document.getElementById('uploadResults').classList.remove('hidden');
                    
                    // Refresh dashboard and master list
                    console.log('üîÑ Refreshing dashboard and master list after upload...');
                    await Promise.all([
                        refreshDashboard(),
                        loadMasterList()
                    ]);
                    console.log('‚úÖ Dashboard and master list refresh completed');
                } else {
                    // Handle specific error types
                    if (response.status === 401 || result.error === 'Authentication Required') {
                        document.getElementById('uploadSummary').innerHTML = `
                            <strong>üîë Authentication Expired</strong><br>
                            Your Microsoft 365 session has expired. Please reconnect.<br>
                            <button onclick="window.location.reload()" class="btn btn-primary" style="margin-top: 10px;">Reconnect</button>
                        `;
                        sessionId = null; // Reset session
                    } else if (response.status === 423 || result.errorType === 'FILE_LOCKED') {
                        document.getElementById('uploadSummary').innerHTML = `
                            <strong>üîí File is Locked</strong><br>
                            ${result.userMessage || result.message}<br>
                            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 0.9em;">
                                <strong>üí° Quick Fix:</strong><br>
                                1. Close the Excel file if it's open in OneDrive or Excel<br>
                                2. Wait 30 seconds for the sync to complete<br>
                                3. Try uploading again
                            </div>
                            <button onclick="handleFileUpload()" class="btn btn-primary" style="margin-top: 10px;">Try Again</button>
                        `;
                    } else {
                        document.getElementById('uploadSummary').innerHTML = `
                            <strong>‚ùå Upload Failed</strong><br>
                            ${result.message || 'Unknown error occurred'}
                        `;
                    }
                    document.getElementById('uploadResults').classList.remove('hidden');
                }
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                
                // Check if it's a network/server error
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    document.getElementById('uploadSummary').innerHTML = `
                        <strong>üåê Connection Error</strong><br>
                        Unable to connect to server. Please check your internet connection and try again.
                    `;
                } else {
                    document.getElementById('uploadSummary').innerHTML = `
                        <strong>‚ùå Upload Failed</strong><br>
                        ${error.message || 'An unexpected error occurred'}
                    `;
                }
                document.getElementById('uploadResults').classList.remove('hidden');
            } finally {
                document.getElementById('uploadProgress').classList.add('hidden');
                fileInput.value = ''; // Reset file input
            }
        }

        // Refresh dashboard statistics
        async function refreshDashboard() {
            console.log('üìä Refreshing dashboard...');
            
            try {
                const response = await fetch('/api/email-automation/master-list/stats', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                const stats = await response.json();
                
                if (stats.success) {
                    document.getElementById('totalLeads').textContent = stats.data.totalLeads || 0;
                    document.getElementById('dueToday').textContent = stats.data.dueToday || 0;
                    document.getElementById('emailsSent').textContent = stats.data.emailsSent || 0;
                    document.getElementById('emailsRead').textContent = stats.data.emailsRead || 0;
                    document.getElementById('repliesReceived').textContent = stats.data.repliesReceived || 0;
                }
            } catch (error) {
                console.error('‚ùå Dashboard refresh error:', error);
            }
        }

        // Load templates
        async function loadTemplates() {
            console.log('üìù Loading templates...');
            
            try {
                const response = await fetch('/api/email-automation/templates', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    templates = result.templates || [];
                    displayTemplates(templates);
                } else {
                    document.getElementById('templatesList').innerHTML = '<p>No templates found.</p>';
                }
            } catch (error) {
                console.error('‚ùå Templates loading error:', error);
                document.getElementById('templatesList').innerHTML = '<p>Error loading templates.</p>';
            }
        }

        // Display templates
        function displayTemplates(templateList) {
            const container = document.getElementById('templatesList');
            const statsContainer = document.getElementById('templateStats');
            
            // Update stats
            const activeCount = templateList.filter(t => t.Active === 'Yes').length;
            statsContainer.innerHTML = `
                <span class="text-muted">${templateList.length} templates (${activeCount} active)</span>
            `;
            
            if (templateList.length === 0) {
                container.innerHTML = `
                    <div class="text-center" style="padding: var(--space-xl);">
                        <div style="font-size: 48px; margin-bottom: var(--space-md);">üìù</div>
                        <p>No templates created yet.</p>
                        <p class="text-muted">Create your first email template to get started.</p>
                        <button class="btn btn-success mt-lg" onclick="openTemplateModal()">
                            ‚ûï Create First Template
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = templateList.map(template => `
                <div class="template-item">
                    <div class="template-header">
                        <div class="flex gap-sm">
                            <strong class="template-name">${template.Template_Name}</strong>
                            <span class="status-badge ${template.Active === 'Yes' ? 'status-read' : 'status-new'}">
                                ${template.Active === 'Yes' ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                            </span>
                        </div>
                        <div class="template-actions">
                            <button class="btn" onclick="previewTemplate('${template.Template_ID}')" title="Preview template">
                                üëÅÔ∏è Preview
                            </button>
                            <button class="btn" onclick="editTemplate('${template.Template_ID}')" title="Edit template">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-warning" onclick="toggleTemplate('${template.Template_ID}')" title="${template.Active === 'Yes' ? 'Deactivate' : 'Activate'} template">
                                ${template.Active === 'Yes' ? '‚è∏Ô∏è Deactivate' : '‚ñ∂Ô∏è Activate'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteTemplate('${template.Template_ID}')" title="Delete template">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    <div class="template-meta">
                        <span>üìã Type: ${template.Template_Type.replace('_', ' ')}</span>
                        <span>üìß Subject: ${template.Subject.substring(0, 50)}${template.Subject.length > 50 ? '...' : ''}</span>
                    </div>
                </div>
            `).join('');
        }

        // Load master list
        async function loadMasterList() {
            console.log('üìã Loading master list...');
            
            try {
                const response = await fetch('/api/email-automation/master-list/data', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    masterListData = result.data || [];
                    console.log(`üìä Loaded ${masterListData.length} leads from master file`);
                    displayMasterList(masterListData);
                } else {
                    document.getElementById('masterListBody').innerHTML = `
                        <tr><td colspan="9" style="text-align: center; padding: 40px;">No leads found.</td></tr>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Master list loading error:', error);
                document.getElementById('masterListBody').innerHTML = `
                    <tr><td colspan="9" style="text-align: center; padding: 40px;">Error loading master list.</td></tr>
                `;
            }
        }

        // Display master list
        function displayMasterList(data) {
            const tbody = document.getElementById('masterListBody');
            const showingCount = document.getElementById('showingCount');
            const totalCount = document.getElementById('totalCount');
            
            // Update counts
            const displayCount = Math.min(data.length, 50);
            showingCount.textContent = displayCount;
            totalCount.textContent = data.length;
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="10" class="text-center loading-cell">
                        <div style="padding: var(--space-xl);">
                            <div style="font-size: 48px; margin-bottom: var(--space-md);">üìã</div>
                            <p>No leads in master list.</p>
                            <p class="text-muted">Upload an Excel file to get started.</p>
                        </div>
                    </td></tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.slice(0, 50).map((lead, index) => `
                <tr>
                    <td><input type="checkbox" class="lead-checkbox" data-email="${lead.Email}" data-index="${index}"></td>
                    <td title="${lead.Name || 'No name'}">${lead.Name || '<span class="text-muted">No name</span>'}</td>
                    <td title="${lead.Email}">${lead.Email || ''}</td>
                    <td title="${lead['Company Name'] || 'No company'}">${lead['Company Name'] || '<span class="text-muted">No company</span>'}</td>
                    <td><span class="status-badge status-${(lead.Status || 'new').toLowerCase()}">${lead.Status || 'New'}</span></td>
                    <td title="${lead.Campaign_Stage || 'First_Contact'}">${(lead.Campaign_Stage || 'First_Contact').replace('_', ' ')}</td>
                    <td title="${lead.Email_Choice || 'AI_Generated'}">${(lead.Email_Choice || 'AI_Generated').replace('_', ' ')}</td>
                    <td title="${lead.Last_Email_Date ? new Date(lead.Last_Email_Date).toLocaleString() : 'Never sent'}">${lead.Last_Email_Date ? new Date(lead.Last_Email_Date).toLocaleDateString() : '-'}</td>
                    <td title="${lead.Next_Email_Date ? new Date(lead.Next_Email_Date).toLocaleString() : 'Not scheduled'}">${lead.Next_Email_Date ? new Date(lead.Next_Email_Date).toLocaleDateString() : '-'}</td>
                    <td>
                        <div class="flex gap-sm">
                            <button class="btn" onclick="editLead('${lead.Email}')" title="Edit lead details">‚úèÔ∏è</button>
                            <button class="btn btn-success" onclick="sendNow('${lead.Email}')" title="Send email now">üìß</button>
                            <button class="btn btn-outline" onclick="viewLeadHistory('${lead.Email}')" title="View lead history">üìä</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            if (data.length > 50) {
                tbody.innerHTML += `
                    <tr><td colspan="10" class="text-center" style="padding: var(--space-lg); color: var(--medium-grey);">
                        <div class="flex-center gap-md">
                            <span>Showing first 50 leads of ${data.length} total</span>
                            <button class="btn btn-outline" onclick="loadMoreLeads()">Load More</button>
                        </div>
                    </td></tr>
                `;
            }
        }

        // Modal functions
        function openTemplateModal() {
            document.getElementById('templateModal').style.display = 'block';
            // Clear form
            document.getElementById('templateForm').reset();
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
        }

        function openCampaignModal() {
            document.getElementById('campaignModal').style.display = 'block';
            // Clear form
            document.getElementById('campaignForm').reset();
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').style.display = 'none';
        }

        // Save template
        async function saveTemplate(e) {
            e.preventDefault();
            
            const templateData = {
                Template_Name: document.getElementById('templateName').value,
                Template_Type: document.getElementById('templateType').value,
                Subject: document.getElementById('templateSubject').value,
                Body: document.getElementById('templateContent').value,
                Active: document.getElementById('templateActive').value
            };
            
            try {
                const response = await fetch('/api/email-automation/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    },
                    body: JSON.stringify(templateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeTemplateModal();
                    await loadTemplates();
                    alert('‚úÖ Template saved successfully!');
                } else {
                    alert('‚ùå Failed to save template: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Template save error:', error);
                alert('‚ùå Failed to save template.');
            }
        }

        // Start campaign
        async function startCampaign(e) {
            e.preventDefault();
            
            const campaignData = {
                campaignName: document.getElementById('campaignName').value,
                emailContentType: document.getElementById('emailContentType').value,
                targetLeads: document.getElementById('targetLeads').value,
                sendSchedule: document.getElementById('sendSchedule').value,
                scheduledTime: document.getElementById('scheduledTime').value,
                followUpDays: parseInt(document.getElementById('followUpDays').value)
            };
            
            try {
                const response = await fetch('/api/email-automation/campaigns/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    },
                    body: JSON.stringify(campaignData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeCampaignModal();
                    await refreshDashboard();
                    alert(`‚úÖ Campaign started successfully! ${result.emailsSent} emails queued.`);
                } else {
                    alert('‚ùå Failed to start campaign: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Campaign start error:', error);
                alert('‚ùå Failed to start campaign.');
            }
        }

        // Utility functions
        function previewTemplate() {
            alert('Template preview functionality coming soon!');
        }

        function previewCampaign() {
            alert('Campaign preview functionality coming soon!');
        }

        function editTemplate(templateId) {
            alert('Template editing functionality coming soon!');
        }

        function toggleTemplate(templateId) {
            alert('Template toggle functionality coming soon!');
        }

        function editLead(email) {
            alert('Lead editing functionality coming soon!');
        }

        function sendNow(email) {
            if (confirm('Send email to this lead now?')) {
                alert('Send now functionality coming soon!');
            }
        }

        function showDueLeads() {
            alert('Due leads view coming soon!');
        }

        function showScheduledCampaigns() {
            alert('Scheduled campaigns view coming soon!');
        }

        function viewMasterList() {
            loadMasterList();
        }

        function exportMasterList() {
            alert('Excel export functionality coming soon!');
        }

        function openAutomationSettings() {
            alert('Automation settings coming soon!');
        }

        function pauseAutomation() {
            if (confirm('Pause all automated email campaigns?')) {
                alert('Pause automation functionality coming soon!');
            }
        }

        function resumeAutomation() {
            if (confirm('Resume all automated email campaigns?')) {
                alert('Resume automation functionality coming soon!');
            }
        }

        function updateCampaignPreview() {
            // Update campaign preview based on selected content type
            const contentType = document.getElementById('emailContentType').value;
            console.log('Content type changed to:', contentType);
        }

        // New Enhanced UX Functions

        // Toggle select all leads
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const leadCheckboxes = document.querySelectorAll('.lead-checkbox');
            
            leadCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            console.log(`${selectAllCheckbox.checked ? 'Selected' : 'Deselected'} all leads`);
        }

        // Select all visible leads
        function selectAllLeads() {
            const leadCheckboxes = document.querySelectorAll('.lead-checkbox');
            leadCheckboxes.forEach(checkbox => checkbox.checked = true);
            document.getElementById('selectAllCheckbox').checked = true;
            console.log('Selected all visible leads');
        }

        // Clear all selections
        function clearSelection() {
            const leadCheckboxes = document.querySelectorAll('.lead-checkbox');
            leadCheckboxes.forEach(checkbox => checkbox.checked = false);
            document.getElementById('selectAllCheckbox').checked = false;
            console.log('Cleared all selections');
        }

        // Change items per page
        function changeItemsPerPage() {
            const itemsPerPage = document.getElementById('itemsPerPage').value;
            console.log('Items per page changed to:', itemsPerPage);
            // TODO: Implement pagination logic
            loadMasterList();
        }

        // Load more leads
        function loadMoreLeads() {
            console.log('Loading more leads...');
            // TODO: Implement load more functionality
            alert('Load more functionality coming soon!');
        }

        // Show dashboard insights
        function showInsights() {
            alert('üìà Analytics insights coming soon!\n\n- Email performance metrics\n- Response rate analytics\n- Best performing templates\n- Lead engagement trends');
        }

        // Show lead details by type
        function showLeadDetails(type) {
            const messages = {
                'total': 'Showing all leads in the system',
                'due': 'Showing leads due for email today'
            };
            console.log(`Showing lead details: ${type}`);
            alert(`üìä ${messages[type] || 'Lead details'}\n\nThis will open a detailed view with filtering options.`);
        }

        // Show email statistics
        function showEmailStats(type) {
            const messages = {
                'sent': 'Email sending statistics and history',
                'read': 'Email open rates and read receipts',
                'replies': 'Email replies and engagement tracking'
            };
            console.log(`Showing email stats: ${type}`);
            alert(`üìà ${messages[type] || 'Email statistics'}\n\nDetailed analytics coming soon!`);
        }

        // Show upload help
        function showUploadHelp() {
            alert('üì§ Upload Help\n\n' +
                  '‚úÖ Supported formats: .xlsx, .xls\n' +
                  '‚úÖ Maximum file size: 10MB\n' +
                  '‚úÖ Required columns: Name, Email, Company\n' +
                  '‚úÖ Optional columns: Title, Phone, Industry\n\n' +
                  'üí° Tip: Duplicate emails will be automatically merged!');
        }

        // Import templates
        function importTemplates() {
            alert('üì• Import Templates\n\nImport templates from:\n- JSON file\n- Another LGA instance\n- Template marketplace\n\nComing soon!');
        }

        // Show campaign history
        function showCampaignHistory() {
            alert('üìà Campaign History\n\nView detailed history of:\n- All past campaigns\n- Performance metrics\n- Success rates\n- Timeline analysis\n\nComing soon!');
        }

        // Bulk actions
        function bulkActions() {
            const selectedLeads = document.querySelectorAll('.lead-checkbox:checked');
            if (selectedLeads.length === 0) {
                alert('Please select leads first using the checkboxes.');
                return;
            }
            
            const actions = [
                'Send bulk email campaign',
                'Update campaign stage',
                'Change email choice',
                'Export selected leads',
                'Delete selected leads'
            ];
            
            alert(`üì¶ Bulk Actions\n\nSelected ${selectedLeads.length} leads\n\nAvailable actions:\n- ${actions.join('\n- ')}\n\nComing soon!`);
        }

        // View automation logs
        function viewAutomationLogs() {
            alert('üìã Automation Activity Logs\n\n' +
                  'üìä Recent Activity:\n' +
                  '- Email campaigns sent\n' +
                  '- Scheduled tasks executed\n' +
                  '- System notifications\n' +
                  '- Error tracking\n\n' +
                  'Detailed logs coming soon!');
        }

        // View lead history
        function viewLeadHistory(email) {
            console.log('Viewing history for:', email);
            alert(`üìä Lead History: ${email}\n\n` +
                  'üìß Email History:\n' +
                  '- All sent emails\n' +
                  '- Open/click tracking\n' +
                  '- Reply history\n\n' +
                  'üìù Activity Timeline:\n' +
                  '- Stage changes\n' +
                  '- Status updates\n' +
                  '- Notes and interactions\n\n' +
                  'Detailed history coming soon!');
        }

        // Delete template (new function)
        function deleteTemplate(templateId) {
            if (confirm('üóëÔ∏è Delete Template\n\nAre you sure you want to delete this template?\n\nThis action cannot be undone.')) {
                console.log('Deleting template:', templateId);
                alert('Delete template functionality coming soon!');
            }
        }

        // Preview template (enhanced)
        function previewTemplate(templateId) {
            if (templateId) {
                console.log('Previewing template:', templateId);
                alert('üëÅÔ∏è Template Preview\n\nShowing template with sample data:\n- Personalized variables filled\n- Formatting preview\n- Mobile/desktop view\n\nEnhanced preview coming soon!');
            } else {
                alert('üëÅÔ∏è Template Preview\n\nPreview functionality coming soon!\n- Real-time preview\n- Sample data insertion\n- Mobile responsiveness check');
            }
        }

        // Debug helper function - call this in browser console if needed
        window.debugAuth = async function() {
            console.log('üîß DEBUG: Testing authentication endpoints...');
            
            try {
                // Test auth status
                console.log('1Ô∏è‚É£ Testing /auth/status...');
                const statusResponse = await fetch('/auth/status');
                const statusData = await statusResponse.json();
                console.log('Status response:', statusData);
                
                // Test auth login
                console.log('2Ô∏è‚É£ Testing /auth/login...');
                const loginResponse = await fetch('/auth/login?redirect=/email-automation');
                const loginData = await loginResponse.json();
                console.log('Login response:', loginData);
                
                if (loginData.success && loginData.authUrl) {
                    console.log('‚úÖ Authentication endpoints working. Auth URL generated:', loginData.authUrl);
                    console.log('üí° You can manually navigate to this URL to test login');
                } else {
                    console.error('‚ùå Authentication endpoint failed:', loginData);
                }
                
            } catch (error) {
                console.error('‚ùå Debug test failed:', error);
            }
        };

        // Filter master list based on search and status
        function filterMasterList() {
            const searchTerm = document.getElementById('searchLeads').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value.toLowerCase();
            
            // If no original data stored, store it
            if (!window.originalMasterListData) {
                window.originalMasterListData = [...masterListData];
            }
            
            let filteredData = window.originalMasterListData.filter(lead => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    (lead.Name && lead.Name.toLowerCase().includes(searchTerm)) ||
                    (lead.Email && lead.Email.toLowerCase().includes(searchTerm)) ||
                    (lead['Company Name'] && lead['Company Name'].toLowerCase().includes(searchTerm));
                
                // Status filter
                const matchesStatus = !statusFilter || 
                    (lead.Status && lead.Status.toLowerCase() === statusFilter);
                
                return matchesSearch && matchesStatus;
            });
            
            // Update display
            displayMasterList(filteredData);
            
            console.log(`Filtered ${filteredData.length} leads from ${window.originalMasterListData.length} total`);
        }
    </script>
</body>
</html>