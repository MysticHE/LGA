<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Automation - LGA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .nav-bar {
            background: white;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-link:hover {
            background: #2980b9;
        }

        .nav-link.active {
            background: #27ae60;
        }

        /* Layout Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        /* Upload Section */
        .upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #3498db;
            background-color: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background-color: #f0fff4;
        }

        .upload-icon {
            font-size: 48px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #95a5a6;
        }

        #fileInput {
            display: none;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Buttons */
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-new { background: #ecf0f1; color: #7f8c8d; }
        .status-sent { background: #d5e8ff; color: #2980b9; }
        .status-read { background: #d4edda; color: #155724; }
        .status-replied { background: #fff3cd; color: #856404; }
        .status-bounced { background: #f8d7da; color: #721c24; }

        /* Progress Bar */
        .progress-container {
            background: #ecf0f1;
            border-radius: 10px;
            height: 8px;
            margin: 15px 0;
        }

        .progress-bar {
            background: linear-gradient(90deg, #3498db, #27ae60);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-left: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .close {
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close:hover {
            color: #2c3e50;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Hidden elements */
        .hidden {
            display: none;
        }

        /* Authentication status */
        .auth-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .auth-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="nav-container">
            <div class="nav-title">Lead Generation Automation</div>
            <div class="nav-links">
                <a href="/" class="nav-link">Lead Scraping</a>
                <a href="/email-automation" class="nav-link active">Email Automation</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Authentication Status -->
        <div id="authStatus" class="auth-status hidden">
            <div id="authMessage"></div>
        </div>

        <!-- Dashboard Stats -->
        <div class="card full-width">
            <div class="card-header">
                <h2 class="card-title">📊 Email Automation Dashboard</h2>
                <button class="btn" onclick="refreshDashboard()">🔄 Refresh</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalLeads">-</div>
                    <div class="stat-label">Total Leads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="dueToday">-</div>
                    <div class="stat-label">Due Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="emailsSent">-</div>
                    <div class="stat-label">Emails Sent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="emailsRead">-</div>
                    <div class="stat-label">Emails Read</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="repliesReceived">-</div>
                    <div class="stat-label">Replies Received</div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Upload Section -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📤 Upload Lead List</h3>
                </div>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">Click or drag Excel file here</div>
                    <div class="upload-subtext">Supports .xlsx files up to 10MB</div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" />
                </div>
                <div id="uploadProgress" class="hidden">
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div id="uploadStatus"></div>
                </div>
                <div id="uploadResults" class="hidden">
                    <h4>Upload Results:</h4>
                    <p id="uploadSummary"></p>
                </div>
            </div>

            <!-- Template Management -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📝 Email Templates</h3>
                    <button class="btn btn-success" onclick="openTemplateModal()">+ New Template</button>
                </div>
                <div id="templatesList">
                    <p>Loading templates...</p>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="loadTemplates()">🔄 Refresh Templates</button>
                </div>
            </div>
        </div>

        <!-- Campaign Management -->
        <div class="card full-width">
            <div class="card-header">
                <h3 class="card-title">🚀 Campaign Management</h3>
                <button class="btn btn-success" onclick="openCampaignModal()">+ Start Campaign</button>
            </div>
            <div class="main-grid">
                <div>
                    <h4>Quick Actions:</h4>
                    <button class="btn" onclick="showDueLeads()">📅 View Due Today</button>
                    <button class="btn btn-warning" onclick="showScheduledCampaigns()">⏰ Scheduled Campaigns</button>
                    <button class="btn" onclick="viewMasterList()">📋 View Master List</button>
                </div>
                <div>
                    <h4>Automation Settings:</h4>
                    <button class="btn" onclick="openAutomationSettings()">⚙️ Configure Rules</button>
                    <button class="btn btn-warning" onclick="pauseAutomation()">⏸️ Pause All</button>
                    <button class="btn btn-success" onclick="resumeAutomation()">▶️ Resume All</button>
                </div>
            </div>
        </div>

        <!-- Master List Table -->
        <div class="card full-width">
            <div class="card-header">
                <h3 class="card-title">📋 Master Lead List</h3>
                <div>
                    <button class="btn" onclick="exportMasterList()">📥 Export Excel</button>
                    <button class="btn" onclick="loadMasterList()">🔄 Refresh</button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="masterListTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Company</th>
                            <th>Status</th>
                            <th>Campaign Stage</th>
                            <th>Email Choice</th>
                            <th>Last Email</th>
                            <th>Next Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="masterListBody">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="spinner"></div>
                                Loading master list...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📝 Email Template Editor</h2>
                <span class="close" onclick="closeTemplateModal()">&times;</span>
            </div>
            <form id="templateForm">
                <div class="form-group">
                    <label class="form-label">Template Name:</label>
                    <input type="text" id="templateName" class="form-input" placeholder="e.g., First Contact Template" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Template Type:</label>
                    <select id="templateType" class="form-select" required>
                        <option value="">Select type...</option>
                        <option value="First_Contact">First Contact</option>
                        <option value="Follow_Up">Follow Up</option>
                        <option value="Nurture">Nurture</option>
                        <option value="Re_Engagement">Re-engagement</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Subject Line:</label>
                    <input type="text" id="templateSubject" class="form-input" placeholder="Use {Name}, {Company}, {Title} for personalization" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Content:</label>
                    <textarea id="templateContent" class="form-textarea" placeholder="Use {Name}, {Company}, {Title} for personalization" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Active:</label>
                    <select id="templateActive" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="previewTemplate()">👁️ Preview</button>
                    <button type="submit" class="btn btn-success">💾 Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Campaign Modal -->
    <div id="campaignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🚀 Start Email Campaign</h2>
                <span class="close" onclick="closeCampaignModal()">&times;</span>
            </div>
            <form id="campaignForm">
                <div class="form-group">
                    <label class="form-label">Campaign Name:</label>
                    <input type="text" id="campaignName" class="form-input" placeholder="e.g., January 2025 Outreach" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Content Type:</label>
                    <select id="emailContentType" class="form-select" required>
                        <option value="">Select content type...</option>
                        <option value="AI_Generated">AI-Generated (Personalized)</option>
                        <option value="Email_Template_1">Email Template 1</option>
                        <option value="Email_Template_2">Email Template 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Target Leads:</label>
                    <select id="targetLeads" class="form-select" required>
                        <option value="new">New Leads Only</option>
                        <option value="due">Due Today</option>
                        <option value="all_new">All New + Due</option>
                        <option value="custom">Custom Selection</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Send Schedule:</label>
                    <select id="sendSchedule" class="form-select" required>
                        <option value="immediate">Send Immediately</option>
                        <option value="scheduled">Schedule for Later</option>
                    </select>
                </div>
                <div id="scheduleDateTime" class="form-group hidden">
                    <label class="form-label">Schedule Date & Time:</label>
                    <input type="datetime-local" id="scheduledTime" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-up Days:</label>
                    <input type="number" id="followUpDays" class="form-input" value="7" min="1" max="30" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="previewCampaign()">👁️ Preview</button>
                    <button type="submit" class="btn btn-success">🚀 Start Campaign</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let sessionId = null;
        let masterListData = [];
        let templates = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeEmailAutomation();
            setupEventListeners();
        });

        // Initialize authentication and load data
        async function initializeEmailAutomation() {
            console.log('🚀 Initializing Email Automation...');
            
            try {
                // Check authentication status
                const authResponse = await fetch('/auth/status');
                const authData = await authResponse.json();
                
                if (authData.authenticated) {
                    sessionId = authData.sessionId;
                    showAuthStatus('✅ Connected to Microsoft 365', 'success');
                    
                    // Load initial data
                    await Promise.all([
                        refreshDashboard(),
                        loadTemplates(),
                        loadMasterList()
                    ]);
                } else {
                    showAuthStatus('⚠️ Microsoft 365 authentication required for email automation', 'error');
                    setTimeout(() => {
                        window.location.href = '/auth/login';
                    }, 3000);
                }
            } catch (error) {
                console.error('❌ Initialization error:', error);
                showAuthStatus('❌ Failed to connect to Microsoft 365. Please try again.', 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // File upload
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.upload-area');
            
            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileUpload();
                }
            });

            // Forms
            document.getElementById('templateForm').addEventListener('submit', saveTemplate);
            document.getElementById('campaignForm').addEventListener('submit', startCampaign);
            
            // Modal close on background click
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // Email content type change
            document.getElementById('emailContentType').addEventListener('change', function() {
                updateCampaignPreview();
            });

            // Send schedule change
            document.getElementById('sendSchedule').addEventListener('change', function() {
                const scheduleDiv = document.getElementById('scheduleDateTime');
                if (this.value === 'scheduled') {
                    scheduleDiv.classList.remove('hidden');
                } else {
                    scheduleDiv.classList.add('hidden');
                }
            });
        }

        // Show authentication status
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            const messageDiv = document.getElementById('authMessage');
            
            statusDiv.className = `auth-status auth-${type}`;
            messageDiv.textContent = message;
            statusDiv.classList.remove('hidden');
        }

        // Handle file upload
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            console.log('📤 Uploading file:', file.name);
            
            // Show progress
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadResults').classList.add('hidden');
            
            const formData = new FormData();
            formData.append('excelFile', file);
            
            try {
                const response = await fetch('/api/email-automation/master-list/upload', {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': sessionId
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show results
                    document.getElementById('uploadSummary').innerHTML = `
                        <strong>✅ Upload Completed</strong><br>
                        📊 Total Processed: ${result.totalProcessed}<br>
                        ✨ New Leads Added: ${result.newLeads}<br>
                        🔄 Duplicates Skipped: ${result.duplicates}
                    `;
                    
                    document.getElementById('uploadResults').classList.remove('hidden');
                    
                    // Refresh dashboard and master list
                    await Promise.all([
                        refreshDashboard(),
                        loadMasterList()
                    ]);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('❌ Upload error:', error);
                document.getElementById('uploadSummary').innerHTML = `
                    <strong>❌ Upload Failed</strong><br>
                    ${error.message}
                `;
                document.getElementById('uploadResults').classList.remove('hidden');
            } finally {
                document.getElementById('uploadProgress').classList.add('hidden');
                fileInput.value = ''; // Reset file input
            }
        }

        // Refresh dashboard statistics
        async function refreshDashboard() {
            console.log('📊 Refreshing dashboard...');
            
            try {
                const response = await fetch('/api/email-automation/master-list/stats', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                const stats = await response.json();
                
                if (stats.success) {
                    document.getElementById('totalLeads').textContent = stats.data.totalLeads || 0;
                    document.getElementById('dueToday').textContent = stats.data.dueToday || 0;
                    document.getElementById('emailsSent').textContent = stats.data.emailsSent || 0;
                    document.getElementById('emailsRead').textContent = stats.data.emailsRead || 0;
                    document.getElementById('repliesReceived').textContent = stats.data.repliesReceived || 0;
                }
            } catch (error) {
                console.error('❌ Dashboard refresh error:', error);
            }
        }

        // Load templates
        async function loadTemplates() {
            console.log('📝 Loading templates...');
            
            try {
                const response = await fetch('/api/email-automation/templates', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    templates = result.templates || [];
                    displayTemplates(templates);
                } else {
                    document.getElementById('templatesList').innerHTML = '<p>No templates found.</p>';
                }
            } catch (error) {
                console.error('❌ Templates loading error:', error);
                document.getElementById('templatesList').innerHTML = '<p>Error loading templates.</p>';
            }
        }

        // Display templates
        function displayTemplates(templateList) {
            const container = document.getElementById('templatesList');
            
            if (templateList.length === 0) {
                container.innerHTML = '<p>No templates created yet.</p>';
                return;
            }
            
            container.innerHTML = templateList.map(template => `
                <div style="border: 1px solid #ecf0f1; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${template.Template_Name}</strong>
                            <span class="status-badge ${template.Active === 'Yes' ? 'status-read' : 'status-new'}">
                                ${template.Active === 'Yes' ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div>
                            <button class="btn" onclick="editTemplate('${template.Template_ID}')">✏️ Edit</button>
                            <button class="btn btn-warning" onclick="toggleTemplate('${template.Template_ID}')">
                                ${template.Active === 'Yes' ? '⏸️ Deactivate' : '▶️ Activate'}
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                        Type: ${template.Template_Type} | Subject: ${template.Subject}
                    </div>
                </div>
            `).join('');
        }

        // Load master list
        async function loadMasterList() {
            console.log('📋 Loading master list...');
            
            try {
                const response = await fetch('/api/email-automation/master-list/data', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    masterListData = result.data || [];
                    displayMasterList(masterListData);
                } else {
                    document.getElementById('masterListBody').innerHTML = `
                        <tr><td colspan="9" style="text-align: center; padding: 40px;">No leads found.</td></tr>
                    `;
                }
            } catch (error) {
                console.error('❌ Master list loading error:', error);
                document.getElementById('masterListBody').innerHTML = `
                    <tr><td colspan="9" style="text-align: center; padding: 40px;">Error loading master list.</td></tr>
                `;
            }
        }

        // Display master list
        function displayMasterList(data) {
            const tbody = document.getElementById('masterListBody');
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="9" style="text-align: center; padding: 40px;">No leads in master list.</td></tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.slice(0, 50).map(lead => `
                <tr>
                    <td>${lead.Name || ''}</td>
                    <td>${lead.Email || ''}</td>
                    <td>${lead['Company Name'] || ''}</td>
                    <td><span class="status-badge status-${(lead.Status || 'new').toLowerCase()}">${lead.Status || 'New'}</span></td>
                    <td>${lead.Campaign_Stage || 'First_Contact'}</td>
                    <td>${lead.Email_Choice || 'AI_Generated'}</td>
                    <td>${lead.Last_Email_Date ? new Date(lead.Last_Email_Date).toLocaleDateString() : '-'}</td>
                    <td>${lead.Next_Email_Date ? new Date(lead.Next_Email_Date).toLocaleDateString() : '-'}</td>
                    <td>
                        <button class="btn" onclick="editLead('${lead.Email}')">✏️</button>
                        <button class="btn btn-success" onclick="sendNow('${lead.Email}')">📧</button>
                    </td>
                </tr>
            `).join('');
            
            if (data.length > 50) {
                tbody.innerHTML += `
                    <tr><td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">
                        Showing first 50 leads. Total: ${data.length} leads.
                    </td></tr>
                `;
            }
        }

        // Modal functions
        function openTemplateModal() {
            document.getElementById('templateModal').style.display = 'block';
            // Clear form
            document.getElementById('templateForm').reset();
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
        }

        function openCampaignModal() {
            document.getElementById('campaignModal').style.display = 'block';
            // Clear form
            document.getElementById('campaignForm').reset();
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').style.display = 'none';
        }

        // Save template
        async function saveTemplate(e) {
            e.preventDefault();
            
            const templateData = {
                Template_Name: document.getElementById('templateName').value,
                Template_Type: document.getElementById('templateType').value,
                Subject: document.getElementById('templateSubject').value,
                Body: document.getElementById('templateContent').value,
                Active: document.getElementById('templateActive').value
            };
            
            try {
                const response = await fetch('/api/email-automation/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    },
                    body: JSON.stringify(templateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeTemplateModal();
                    await loadTemplates();
                    alert('✅ Template saved successfully!');
                } else {
                    alert('❌ Failed to save template: ' + result.message);
                }
            } catch (error) {
                console.error('❌ Template save error:', error);
                alert('❌ Failed to save template.');
            }
        }

        // Start campaign
        async function startCampaign(e) {
            e.preventDefault();
            
            const campaignData = {
                campaignName: document.getElementById('campaignName').value,
                emailContentType: document.getElementById('emailContentType').value,
                targetLeads: document.getElementById('targetLeads').value,
                sendSchedule: document.getElementById('sendSchedule').value,
                scheduledTime: document.getElementById('scheduledTime').value,
                followUpDays: parseInt(document.getElementById('followUpDays').value)
            };
            
            try {
                const response = await fetch('/api/email-automation/campaigns/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    },
                    body: JSON.stringify(campaignData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeCampaignModal();
                    await refreshDashboard();
                    alert(`✅ Campaign started successfully! ${result.emailsSent} emails queued.`);
                } else {
                    alert('❌ Failed to start campaign: ' + result.message);
                }
            } catch (error) {
                console.error('❌ Campaign start error:', error);
                alert('❌ Failed to start campaign.');
            }
        }

        // Utility functions
        function previewTemplate() {
            alert('Template preview functionality coming soon!');
        }

        function previewCampaign() {
            alert('Campaign preview functionality coming soon!');
        }

        function editTemplate(templateId) {
            alert('Template editing functionality coming soon!');
        }

        function toggleTemplate(templateId) {
            alert('Template toggle functionality coming soon!');
        }

        function editLead(email) {
            alert('Lead editing functionality coming soon!');
        }

        function sendNow(email) {
            if (confirm('Send email to this lead now?')) {
                alert('Send now functionality coming soon!');
            }
        }

        function showDueLeads() {
            alert('Due leads view coming soon!');
        }

        function showScheduledCampaigns() {
            alert('Scheduled campaigns view coming soon!');
        }

        function viewMasterList() {
            loadMasterList();
        }

        function exportMasterList() {
            alert('Excel export functionality coming soon!');
        }

        function openAutomationSettings() {
            alert('Automation settings coming soon!');
        }

        function pauseAutomation() {
            if (confirm('Pause all automated email campaigns?')) {
                alert('Pause automation functionality coming soon!');
            }
        }

        function resumeAutomation() {
            if (confirm('Resume all automated email campaigns?')) {
                alert('Resume automation functionality coming soon!');
            }
        }

        function updateCampaignPreview() {
            // Update campaign preview based on selected content type
            const contentType = document.getElementById('emailContentType').value;
            console.log('Content type changed to:', contentType);
        }
    </script>
</body>
</html>